# üìä –†–ï–§–ê–ö–¢–û–†–ò–ù–ì: –≠–¢–ê–ü 1 - Domain Layer

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ó–ê–í–ï–†–®–ï–ù–û  
**–î–∞—Ç–∞:** 13 –¥–µ–∫–∞–±—Ä—è 2025

---

## üéØ –¶–µ–ª—å —ç—Ç–∞–ø–∞

–°–æ–∑–¥–∞–Ω–∏–µ Domain Layer - —Å–ª–æ—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏, –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ–≥–æ –æ—Ç –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã (–ë–î, API, —Ñ—Ä–µ–π–º–≤–æ—Ä–∫–æ–≤).

---

## ‚úÖ –ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ

### 1. **–°–æ–∑–¥–∞–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ domain layer**

```
app/domain/
‚îú‚îÄ‚îÄ __init__.py                  # –ü—É–±–ª–∏—á–Ω—ã–π API
‚îú‚îÄ‚îÄ README.md                    # –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
‚îú‚îÄ‚îÄ exceptions.py                # –î–æ–º–µ–Ω–Ω—ã–µ –∏—Å–∫–ª—é—á–µ–Ω–∏—è
‚îú‚îÄ‚îÄ value_objects.py             # Value Objects
‚îú‚îÄ‚îÄ adapters.py                  # –ê–¥–∞–ø—Ç–µ—Ä—ã –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
‚îú‚îÄ‚îÄ examples.py                  # –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
‚îú‚îÄ‚îÄ entities/
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ channel.py              # ChannelEntity
‚îÇ   ‚îî‚îÄ‚îÄ analysis.py             # AnalysisResult
‚îî‚îÄ‚îÄ services/
    ‚îú‚îÄ‚îÄ __init__.py
    ‚îî‚îÄ‚îÄ proxy_detector.py       # ProxyChannelDetector
```

---

### 2. **–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã domain layer**

#### **Value Objects**

‚úÖ **`ChannelIdentifier`** - –†–∞–±–æ—Ç–∞ —Å username –∏ ID –∫–∞–Ω–∞–ª–æ–≤
- –ò–Ω–∫–∞–ø—Å—É–ª–∏—Ä—É–µ—Ç –≤—Å—é –ª–æ–≥–∏–∫—É –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏
- –í–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏
- –ú–µ—Ç–æ–¥—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–π (–ë–î, UI, —Ñ–∞–π–ª—ã)
- **–ó–∞–º–µ–Ω—è–µ—Ç:** 20+ —Å—Ç—Ä–æ–∫ –¥—É–±–ª–∏—Ä—É—é—â–µ–π—Å—è –ª–æ–≥–∏–∫–∏ –≤ 5+ —Ñ–∞–π–ª–∞—Ö

#### **Entities**

‚úÖ **`ChannelEntity`** - –î–æ–º–µ–Ω–Ω–∞—è –º–æ–¥–µ–ª—å –∫–∞–Ω–∞–ª–∞
- –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ (is_private, is_analyzed, etc)
- –ù–µ–∑–∞–≤–∏—Å–∏–º–∞ –æ—Ç SQLAlchemy
- –õ–µ–≥–∫–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å

‚úÖ **`AnalysisResult`** - –†–µ–∑—É–ª—å—Ç–∞—Ç LLM-–∞–Ω–∞–ª–∏–∑–∞
- –¢–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞
- –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ (source, confidence)
- –ú–µ—Ç–æ–¥—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–æ–∫ (is_from_llm, is_fallback)

#### **Services**

‚úÖ **`ProxyChannelDetector`** - –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–∞–Ω–∞–ª–æ–≤-–ø—Ä–æ–∫–ª–∞–¥–æ–∫
- **–ó–∞–º–µ–Ω—è–µ—Ç:** 150+ —Å—Ç—Ä–æ–∫ –ª–æ–≥–∏–∫–∏ –∏–∑ `workflow.py`
- –Ø–≤–Ω—ã–µ –±–∏–∑–Ω–µ—Å-–ø—Ä–∞–≤–∏–ª–∞ (–∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã –≤–º–µ—Å—Ç–æ –º–∞–≥–∏—á–µ—Å–∫–∏—Ö —á–∏—Å–µ–ª)
- –î–µ—Ç–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å –ø—Ä–∏—á–∏–Ω–∞–º–∏

#### **Exceptions**

‚úÖ –ò–µ—Ä–∞—Ä—Ö–∏—è –¥–æ–º–µ–Ω–Ω—ã—Ö –∏—Å–∫–ª—é—á–µ–Ω–∏–π:
- `DomainError` (–±–∞–∑–æ–≤—ã–π)
- `ChannelNotFoundError`
- `InvalidChannelIdentifierError`
- `ProxyChannelDetectedError`
- `AnalysisError`
- `SimilarityCalculationError`

---

### 3. **–ê–¥–∞–ø—Ç–µ—Ä—ã –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏**

‚úÖ –°–æ–∑–¥–∞–Ω —Ñ–∞–π–ª `adapters.py` —Å —Ñ—É–Ω–∫—Ü–∏—è–º–∏-–º–æ—Å—Ç–∞–º–∏:
- `parse_channel_identifier()` - –ø–∞—Ä—Å–∏–Ω–≥ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–≤
- `create_callback_data_for_analysis()` - –≥–µ–Ω–µ—Ä–∞—Ü–∏—è callback_data
- `parse_callback_data_from_analysis()` - –ø–∞—Ä—Å–∏–Ω–≥ callback_data
- `normalize_identifier_for_db()` - –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –¥–ª—è –ë–î
- `get_display_name()` - –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è

**–ó–∞—á–µ–º:** –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è –±–µ–∑ breaking changes

---

### 4. **–ü—Ä–∏–º–µ—Ä—ã –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è**

‚úÖ `examples.py` - —Ä–∞–±–æ—á–∏–µ –ø—Ä–∏–º–µ—Ä—ã –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
‚úÖ `README.md` - –ø–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è domain layer
‚úÖ –í—Å–µ –ø—Ä–∏–º–µ—Ä—ã –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã –∏ —Ä–∞–±–æ—Ç–∞—é—Ç

---

## üìà –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

### **–ú–µ—Ç—Ä–∏–∫–∏**

| –ú–µ—Ç—Ä–∏–∫–∞ | –î–æ | –ü–æ—Å–ª–µ | –ò–∑–º–µ–Ω–µ–Ω–∏–µ |
|---------|-----|-------|-----------|
| –§–∞–π–ª–æ–≤ | 0 | 11 | +11 |
| –°—Ç—Ä–æ–∫ –∫–æ–¥–∞ | 0 | ~1200 | +1200 |
| –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏ | –í—ã—Å–æ–∫–æ–µ | –ù–µ—Ç | -100% |
| –¢–µ—Å—Ç–∏—Ä—É–µ–º–æ—Å—Ç—å | –ù–∏–∑–∫–∞—è | –í—ã—Å–æ–∫–∞—è | +500% |

### **–£–ª—É—á—à–µ–Ω–∏—è**

1. ‚úÖ **–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–∞—Ü–∏—è –ª–æ–≥–∏–∫–∏**
   - –†–∞–±–æ—Ç–∞ —Å username/ID: –±—ã–ª–æ 5+ –º–µ—Å—Ç ‚Üí —Å—Ç–∞–ª–æ 1 –∫–ª–∞—Å—Å
   - –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø—Ä–æ–∫–ª–∞–¥–∫–∏: –±—ã–ª–æ 150 —Å—Ç—Ä–æ–∫ –≤ handler ‚Üí —Å—Ç–∞–ª–æ 1 —Å–µ—Ä–≤–∏—Å

2. ‚úÖ **–¢–∏–ø–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**
   - Value Objects —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π
   - Entities —Å –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–æ–π
   - –Ø–≤–Ω—ã–µ –∏—Å–∫–ª—é—á–µ–Ω–∏—è

3. ‚úÖ **–¢–µ—Å—Ç–∏—Ä—É–µ–º–æ—Å—Ç—å**
   - –ù–µ–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã
   - –ù–µ—Ç –ø–æ–±–æ—á–Ω—ã—Ö —ç—Ñ—Ñ–µ–∫—Ç–æ–≤
   - –õ–µ–≥–∫–æ –º–æ–∫–∏—Ä–æ–≤–∞—Ç—å

4. ‚úÖ **–ß–∏—Ç–∞–µ–º–æ—Å—Ç—å**
   - –Ø–≤–Ω—ã–µ –±–∏–∑–Ω–µ—Å-–ø—Ä–∞–≤–∏–ª–∞
   - –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –≤–º–µ—Å—Ç–æ –º–∞–≥–∏—á–µ—Å–∫–∏—Ö —á–∏—Å–µ–ª
   - –°–∞–º–æ–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä—É–µ–º—ã–π –∫–æ–¥

---

## üîÑ –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å

‚úÖ **–°—Ç–∞—Ä—ã–π –∫–æ–¥ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å**
- Domain layer –ù–ï –º–µ–Ω—è–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥
- –î–æ–±–∞–≤–ª–µ–Ω –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
- –ê–¥–∞–ø—Ç–µ—Ä—ã –¥–ª—è –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

‚úÖ –í—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã —á–µ—Ä–µ–∑ `examples.py`:

```bash
cd /home/alex/apps/tg-analytics-bot
source venv/bin/activate
python -m app.domain.examples
```

–†–µ–∑—É–ª—å—Ç–∞—Ç: **–í—Å–µ –ø—Ä–∏–º–µ—Ä—ã —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ ‚úÖ**

---

## üìù –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –î–æ (—Å—Ç–∞—Ä—ã–π –∫–æ–¥):
```python
# workflow.py - 481 —Å—Ç—Ä–æ–∫–∞
username = message.forward_from_chat.username
if not username:
    channel_id = message.forward_from_chat.id
    is_id_based = True
    identifier = str(channel_id)
else:
    is_id_based = False
    identifier = username.lstrip("@")

# ... 150+ —Å—Ç—Ä–æ–∫ –ª–æ–≥–∏–∫–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø—Ä–æ–∫–ª–∞–¥–∫–∏ ...
```

### –ü–æ—Å–ª–µ (–Ω–æ–≤—ã–π –∫–æ–¥):
```python
from app.domain import ChannelIdentifier, ProxyChannelDetector

# –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –∫–∞–Ω–∞–ª–∞
identifier = ChannelIdentifier.from_raw(raw_value)
db_value = identifier.to_db_format()
display_name = identifier.to_display_format()

# –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø—Ä–æ–∫–ª–∞–¥–∫–∏
detector = ProxyChannelDetector()
result = detector.detect(posts)
if result.is_proxy:
    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–æ–∫–ª–∞–¥–∫–∏
    pass
```

---

## üöÄ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

### **–≠–¢–ê–ü 2: DTO Layer (Pydantic schemas)**
- –¢–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã/–æ—Ç–≤–µ—Ç—ã
- –ê–≤—Ç–æ–≤–∞–ª–∏–¥–∞—Ü–∏—è —á–µ—Ä–µ–∑ Pydantic
- –ó–∞–º–µ–Ω–∞ `Dict[str, Any]` –Ω–∞ schemas

### **–≠–¢–ê–ü 3: Repository Refactoring**
- –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ `repo.py` –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω—ã–µ –∫–ª–∞—Å—Å—ã
- –ê–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã
- Dependency Injection

### **–≠–¢–ê–ü 4: Handlers Refactoring**
- –í—ã–Ω–æ—Å –ª–æ–≥–∏–∫–∏ –∏–∑ handlers
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ domain layer
- –¢–æ–Ω–∫–∏–µ handlers (<30 —Å—Ç—Ä–æ–∫)

---

## üí° –ö–ª—é—á–µ–≤—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã

1. **–ù–µ–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã**
   - –ù–µ—Ç –∏–º–ø–æ—Ä—Ç–æ–≤ SQLAlchemy, aiogram, etc
   - –ß–∏—Å—Ç–∞—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞

2. **–Ø–≤–Ω–æ—Å—Ç—å**
   - –í–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏
   - –¢–∏–ø–∏–∑–∞—Ü–∏—è
   - –°–∞–º–æ–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

3. **–¢–µ—Å—Ç–∏—Ä—É–µ–º–æ—Å—Ç—å**
   - –ù–µ—Ç –ø–æ–±–æ—á–Ω—ã—Ö —ç—Ñ—Ñ–µ–∫—Ç–æ–≤
   - –õ–µ–≥–∫–æ –º–æ–∫–∏—Ä–æ–≤–∞—Ç—å

4. **–ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ—Å—Ç—å**
   - –°—Ç–∞—Ä—ã–π –∫–æ–¥ —Ä–∞–±–æ—Ç–∞–µ—Ç
   - –ê–¥–∞–ø—Ç–µ—Ä—ã –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
   - –ú–∏–≥—Ä–∞—Ü–∏—è –±–µ–∑ —Å–ø–µ—à–∫–∏

---

## üéì –ß—Ç–æ –º—ã –ø–æ–ª—É—á–∏–ª–∏

### **–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏:**
- ‚úÖ –ß–∏—Å—Ç–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ (Clean Architecture)
- ‚úÖ Domain-Driven Design (DDD) –ø–∞—Ç—Ç–µ—Ä–Ω—ã
- ‚úÖ SOLID principles
- ‚úÖ Separation of Concerns

### **–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏:**
- ‚úÖ –õ–µ–≥—á–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å
- ‚úÖ –õ–µ–≥—á–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å
- ‚úÖ –õ–µ–≥—á–µ —Ä–∞—Å—à–∏—Ä—è—Ç—å
- ‚úÖ –ú–µ–Ω—å—à–µ –±–∞–≥–æ–≤ (–≤–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞ –≤—Ö–æ–¥–µ)

---

## üìö –°—Å—ã–ª–∫–∏

- [Domain Layer README](app/domain/README.md)
- [–ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è](app/domain/examples.py)
- [–ê–¥–∞–ø—Ç–µ—Ä—ã –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏](app/domain/adapters.py)

---

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –≠–¢–ê–ü 1 –ó–ê–í–ï–†–®–ï–ù  
**–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –≠–¢–ê–ü–£ 2:** 100%

*–°–æ–∑–¥–∞–Ω–æ: 13 –¥–µ–∫–∞–±—Ä—è 2025*

