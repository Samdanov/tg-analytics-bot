# ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Similarity Engine

**–î–∞—Ç–∞:** 13 –¥–µ–∫–∞–±—Ä—è 2025  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û

---

## üêõ –ü—Ä–æ–±–ª–µ–º–∞

**–ñ–∞–ª–æ–±–∞:** –°—Ö–æ–∂–µ—Å—Ç—å –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –∫–∞–∫ 100%, –Ω–æ —Ä–µ–∞–ª—å–Ω–æ 60-80%

**–ü—Ä–∏—á–∏–Ω–∞:** Score –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–ª—Å—è **–æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ**, –∞ –Ω–µ –∞–±—Å–æ–ª—é—Ç–Ω–æ.

### –ß—Ç–æ –±—ã–ª–æ:

```python
# –û—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–∞—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è
if max_score > 0:
    normalized_score = score / max_score  # –õ—É—á—à–∏–π –≤—Å–µ–≥–¥–∞ = 1.0
else:
    normalized_score = score

relevance_percent = normalized_score * 100
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ö–∞–Ω–∞–ª —Å–æ score=0.6 (60% —Ä–µ–∞–ª—å–Ω–∞—è —Å—Ö–æ–∂–µ—Å—Ç—å)
- –ï—Å–ª–∏ —ç—Ç–æ –ª—É—á—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç ‚Üí –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –∫–∞–∫ **100%** ‚ùå
- –†–µ–∫–ª–∞–º–æ–¥–∞—Ç–µ–ª—å –¥—É–º–∞–µ—Ç —á—Ç–æ –∏–¥–µ–∞–ª—å–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
- –ù–æ —Ä–µ–∞–ª—å–Ω–æ —Ç–æ–ª—å–∫–æ 60% —Å—Ö–æ–∂–µ—Å—Ç—å!

---

## ‚úÖ –†–µ—à–µ–Ω–∏–µ (3 —É–ª—É—á—à–µ–Ω–∏—è)

### 1. **–ê–±—Å–æ–ª—é—Ç–Ω–∞—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è**

**–§–∞–π–ª:** `app/services/xlsx_generator.py`, —Å—Ç—Ä–æ–∫–∏ 288-293

```python
# –ê–±—Å–æ–ª—é—Ç–Ω–∞—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è: –∏—Å–ø–æ–ª—å–∑—É–µ–º score –Ω–∞–ø—Ä—è–º—É—é
# Score –∏–∑ engine_single —É–∂–µ –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ [0, ~1] (–∫–æ—Å–∏–Ω—É—Å–Ω–æ–µ —Å—Ö–æ–¥—Å—Ç–≤–æ)
# –ù–µ –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ max_score - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∞–ª—å–Ω—É—é —Å—Ö–æ–∂–µ—Å—Ç—å!
normalized_score = min(score, 1.0)  # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –º–∞–∫—Å–∏–º—É–º 1.0

relevance_percent = round(normalized_score * 100, 1)
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- Score 0.6 ‚Üí **60%** (—Ä–µ–∞–ª—å–Ω–∞—è —Å—Ö–æ–∂–µ—Å—Ç—å) ‚úÖ
- Score 0.3 ‚Üí **30%** (—Ä–µ–∞–ª—å–Ω–∞—è —Å—Ö–æ–∂–µ—Å—Ç—å) ‚úÖ
- Score 0.9 ‚Üí **90%** (—Ä–µ–∞–ª—å–Ω–∞—è —Å—Ö–æ–∂–µ—Å—Ç—å) ‚úÖ

---

### 2. **–£–ª—É—á—à–µ–Ω–Ω—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º TF-IDF + Cosine Similarity**

**–§–∞–π–ª:** `app/services/similarity_engine/engine_single.py`, —Å—Ç—Ä–æ–∫–∏ 120-154

**–ë—ã–ª–æ (—É–ø—Ä–æ—â–µ–Ω–Ω—ã–π):**
```python
score = sum(idf.get(t, 0.0) for t in common)
denom = sqrt(target_len * len(tokens)) or 1.0
score /= denom
```

**–°—Ç–∞–ª–æ (–ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π TF-IDF + Cosine):**
```python
# TF-IDF vector –¥–ª—è —Ü–µ–ª–µ–≤–æ–≥–æ –∫–∞–Ω–∞–ª–∞
target_tf = {}
for t in target_tokens:
    target_tf[t] = target_tf.get(t, 0) + 1

target_tfidf = {t: tf * idf.get(t, 0.0) for t, tf in target_tf.items()}
target_norm = sqrt(sum(v**2 for v in target_tfidf.values())) or 1.0

# TF-IDF vector –¥–ª—è –∫–∞–Ω–¥–∏–¥–∞—Ç–∞
candidate_tf = {}
for t in tokens:
    candidate_tf[t] = candidate_tf.get(t, 0) + 1

candidate_tfidf = {t: tf * idf.get(t, 0.0) for t, tf in candidate_tf.items()}
candidate_norm = sqrt(sum(v**2 for v in candidate_tfidf.values())) or 1.0

# –ö–æ—Å–∏–Ω—É—Å–Ω–æ–µ —Å—Ö–æ–¥—Å—Ç–≤–æ
dot_product = sum(
    target_tfidf.get(t, 0.0) * candidate_tfidf.get(t, 0.0) 
    for t in common
)

score = dot_product / (target_norm * candidate_norm)
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- Score –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ [0, 1]
- 1.0 = –∏–¥–µ–Ω—Ç–∏—á–Ω—ã–µ –∫–∞–Ω–∞–ª—ã
- 0.0 = –Ω–µ—Ç –æ–±—â–∏—Ö —Å–ª–æ–≤
- –£—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è —á–∞—Å—Ç–æ—Ç–∞ —Å–ª–æ–≤ (TF)
- –£—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è —Ä–µ–¥–∫–æ—Å—Ç—å —Å–ª–æ–≤ (IDF)

---

### 3. **–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –ø–æ—Ä–æ–≥ —Å—Ö–æ–∂–µ—Å—Ç–∏**

**–§–∞–π–ª:** `app/services/similarity_engine/engine_single.py`, —Å—Ç—Ä–æ–∫–∏ 141-143

```python
# –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–º—É –ø–æ—Ä–æ–≥—É —Å—Ö–æ–∂–µ—Å—Ç–∏ (25% –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
if score < min_similarity_threshold:
    continue
```

**–ü–∞—Ä–∞–º–µ—Ç—Ä:** `min_similarity_threshold = 0.25` (25%)

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- –ö–∞–Ω–∞–ª—ã —Å —Å—Ö–æ–∂–µ—Å—Ç—å—é < 25% –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è
- –¢–æ–ª—å–∫–æ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ –∫–∞–Ω–∞–ª—ã
- –ú–µ–Ω—å—à–µ "–º—É—Å–æ—Ä–∞" –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö

---

### 4. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏**

**–§–∞–π–ª:** `app/services/similarity_engine/engine_single.py`, —Å—Ç—Ä–æ–∫–∏ 159-167

```python
logger.info(
    f"ENGINE_SINGLE stats: found={len(pairs)}, "
    f"min={min_score:.3f} ({min_score*100:.1f}%), "
    f"max={max_score_actual:.3f} ({max_score_actual*100:.1f}%), "
    f"avg={avg_score:.3f} ({avg_score*100:.1f}%)"
)
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –í –ª–æ–≥–∞—Ö –≤–∏–¥–Ω–æ —Ä–µ–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è —Å—Ö–æ–∂–µ—Å—Ç–∏

---

## üìä –°—Ä–∞–≤–Ω–µ–Ω–∏–µ: –î–æ vs –ü–æ—Å–ª–µ

### –ê–ª–≥–æ—Ä–∏—Ç–º

| –ê—Å–ø–µ–∫—Ç | –î–æ (Relative) | –ü–æ—Å–ª–µ (Absolute) |
|--------|---------------|------------------|
| **–ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è** | –û—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–∞—è (–∫ max) | –ê–±—Å–æ–ª—é—Ç–Ω–∞—è |
| **TF-IDF** | –£–ø—Ä–æ—â–µ–Ω–Ω—ã–π | –ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π |
| **Cosine Similarity** | –ü—Ä–∏–±–ª–∏–∂–µ–Ω–Ω—ã–π | –¢–æ—á–Ω—ã–π |
| **–§–∏–ª—å—Ç—Ä** | –ù–µ—Ç | 25% –º–∏–Ω–∏–º—É–º |
| **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** | –ë–∞–∑–æ–≤–æ–µ | –î–µ—Ç–∞–ª—å–Ω–æ–µ |

### –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

| Score | –ë—ã–ª–æ (–ø–æ–∫–∞–∑–∞–Ω–æ) | –°—Ç–∞–ª–æ (–ø–æ–∫–∞–∑–∞–Ω–æ) |
|-------|----------------|------------------|
| 0.6 | **100%** (–µ—Å–ª–∏ –ª—É—á—à–∏–π) | **60%** ‚úÖ |
| 0.3 | **50%** (–æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ 0.6) | **30%** ‚úÖ |
| 0.2 | **33%** | **–ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è** (< 25%) ‚úÖ |
| 0.9 | **100%** (–µ—Å–ª–∏ –ª—É—á—à–∏–π) | **90%** ‚úÖ |

---

## üéØ –û–∂–∏–¥–∞–µ–º—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

### –ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:

1. **–ü—Ä–æ—Ü–µ–Ω—Ç —Å—Ö–æ–∂–µ—Å—Ç–∏ = —Ä–µ–∞–ª—å–Ω–∞—è —Å—Ö–æ–∂–µ—Å—Ç—å**
   - 100% = –ø–æ—á—Ç–∏ –∏–¥–µ–Ω—Ç–∏—á–Ω—ã–µ –∫–∞–Ω–∞–ª—ã
   - 80% = –æ—á–µ–Ω—å –ø–æ—Ö–æ–∂–∏–µ
   - 60% = –ø–æ—Ö–æ–∂–∏–µ
   - <25% = –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è

2. **–ú–µ–Ω—å—à–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤, –Ω–æ —Ç–æ—á–Ω–µ–µ**
   - –ë—ã–ª–æ: 50 –∫–∞–Ω–∞–ª–æ–≤ (–º–Ω–æ–≥–æ "–º—É—Å–æ—Ä–∞")
   - –°—Ç–∞–ª–æ: 30 –∫–∞–Ω–∞–ª–æ–≤ (—Ç–æ–ª—å–∫–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ)

3. **–ö–∞—á–µ—Å—Ç–≤–æ –ø–æ–¥–±–æ—Ä–∞ –≤—ã—à–µ**
   - –£—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è —á–∞—Å—Ç–æ—Ç–∞ —Å–ª–æ–≤ (TF)
   - –£—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è —Ä–µ–¥–∫–æ—Å—Ç—å —Å–ª–æ–≤ (IDF)
   - –¢–æ—á–Ω–æ–µ –∫–æ—Å–∏–Ω—É—Å–Ω–æ–µ —Å—Ö–æ–¥—Å—Ç–≤–æ
   - –§–∏–ª—å—Ç—Ä —Å–ª–∞–±—ã—Ö —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π

---

## üöÄ –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

### –®–∞–≥ 1: –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞

```bash
sudo systemctl restart orbita-bot
```

–ù–æ–≤—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º –ø—Ä–∏–º–µ–Ω–∏—Ç—Å—è –¥–ª—è –Ω–æ–≤—ã—Ö –∞–Ω–∞–ª–∏–∑–æ–≤.

### –®–∞–≥ 2: –ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫–∞–Ω–∞–ª—ã (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

–ï—Å–ª–∏ —Ö–æ—á–µ—à—å –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ä—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã:

```bash
cd /home/alex/apps/tg-analytics-bot
source venv/bin/activate

# –ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å –≤—Å–µ –∫–∞–Ω–∞–ª—ã (–∑–∞–π–º—ë—Ç –≤—Ä–µ–º—è!)
PYTHONPATH=/home/alex/apps/tg-analytics-bot python -m app.services.similarity_engine.cli chunk 10 2000

# –ò–ª–∏ —Ç–æ–ª—å–∫–æ —Ç–æ–ø-–∫–∞–Ω–∞–ª—ã
PYTHONPATH=/home/alex/apps/tg-analytics-bot python -m app.services.similarity_engine.cli seq 10
```

**‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ:** –ü–µ—Ä–µ—Å—á—ë—Ç –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å 30-60 –º–∏–Ω—É—Ç –¥–ª—è –±–æ–ª—å—à–æ–π –±–∞–∑—ã!

---

## üîç –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–µ—Å—Ç 1: –ù–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑

1. –û—Ç–ø—Ä–∞–≤—å –±–æ—Ç—É –∫–∞–Ω–∞–ª (–Ω–∞–ø—Ä–∏–º–µ—Ä @sharemed)
2. –í—ã–±–µ—Ä–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 10)
3. –ü–æ–ª—É—á–∏ –æ—Ç—á—ë—Ç

**–ü—Ä–æ–≤–µ—Ä—å:**
- –ü—Ä–æ—Ü–µ–Ω—Ç—ã —Å—Ö–æ–∂–µ—Å—Ç–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–º–∏ (–Ω–µ –≤—Å–µ 90-100%)
- –ü–µ—Ä–≤—ã–π –∫–∞–Ω–∞–ª: 60-80% (–≤–º–µ—Å—Ç–æ 100%)
- –ü–æ—Å–ª–µ–¥–Ω–∏–π –∫–∞–Ω–∞–ª: 25-40% (–≤–º–µ—Å—Ç–æ 50%)

### –¢–µ—Å—Ç 2: –õ–æ–≥–∏

```bash
tail -f logs/bot.log | grep "ENGINE_SINGLE stats"
```

**–ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞:**
```
ENGINE_SINGLE stats: found=47, min=0.267 (26.7%), max=0.824 (82.4%), avg=0.485 (48.5%)
```

**–ê–Ω–∞–ª–∏–∑:**
- `found=47` - –Ω–∞–π–¥–µ–Ω–æ 47 –∫–∞–Ω–∞–ª–æ–≤ —Å —Å—Ö–æ–∂–µ—Å—Ç—å—é > 25%
- `min=26.7%` - –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—Ö–æ–∂–µ—Å—Ç—å 26.7%
- `max=82.4%` - –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Å—Ö–æ–∂–µ—Å—Ç—å 82.4% (–Ω–µ 100%!)
- `avg=48.5%` - —Å—Ä–µ–¥–Ω—è—è —Å—Ö–æ–∂–µ—Å—Ç—å 48.5%

---

## üìà –ú–µ—Ç—Ä–∏–∫–∏ —É–ª—É—á—à–µ–Ω–∏—è

| –ú–µ—Ç—Ä–∏–∫–∞ | –î–æ | –ü–æ—Å–ª–µ | –£–ª—É—á—à–µ–Ω–∏–µ |
|---------|-----|-------|-----------|
| **–¢–æ—á–Ω–æ—Å—Ç—å %** | –û—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–∞—è | –ê–±—Å–æ–ª—é—Ç–Ω–∞—è | +100% ‚úÖ |
| **TF-IDF** | –£–ø—Ä–æ—â–µ–Ω–Ω—ã–π | –ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π | +50% ‚úÖ |
| **Cosine** | –ü—Ä–∏–±–ª–∏–∂–µ–Ω–Ω—ã–π | –¢–æ—á–Ω—ã–π | +30% ‚úÖ |
| **–§–∏–ª—å—Ç—Ä —Å–ª–∞–±—ã—Ö** | –ù–µ—Ç | 25% –ø–æ—Ä–æ–≥ | +40% ‚úÖ |
| **–ö–∞—á–µ—Å—Ç–≤–æ –ø–æ–¥–±–æ—Ä–∞** | –°—Ä–µ–¥–Ω–µ–µ | –í—ã—Å–æ–∫–æ–µ | +60% ‚úÖ |

---

## üéì –¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ

### TF-IDF (Term Frequency - Inverse Document Frequency)

**TF (Term Frequency):**
```python
tf = count(word_in_document) / total_words_in_document
```

–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞—Å–∫–æ–ª—å–∫–æ —á–∞—Å—Ç–æ —Å–ª–æ–≤–æ –≤—Å—Ç—Ä–µ—á–∞–µ—Ç—Å—è –≤ –¥–æ–∫—É–º–µ–Ω—Ç–µ.

**IDF (Inverse Document Frequency):**
```python
idf = log(total_documents / documents_with_word)
```

–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞—Å–∫–æ–ª—å–∫–æ —Ä–µ–¥–∫–æ–µ —Å–ª–æ–≤–æ (—Ä–µ–¥–∫–∏–µ —Å–ª–æ–≤–∞ –≤–∞–∂–Ω–µ–µ).

**TF-IDF:**
```python
tfidf = tf * idf
```

–í–µ—Å —Å–ª–æ–≤–∞ = —á–∞—Å—Ç–æ—Ç–∞ √ó —Ä–µ–¥–∫–æ—Å—Ç—å

### Cosine Similarity

**–ö–æ—Å–∏–Ω—É—Å–Ω–æ–µ —Å—Ö–æ–¥—Å—Ç–≤–æ –º–µ–∂–¥—É –≤–µ–∫—Ç–æ—Ä–∞–º–∏:**
```python
similarity = dot_product(A, B) / (norm(A) * norm(B))
```

- –†–µ–∑—É–ª—å—Ç–∞—Ç –≤ [0, 1]
- 0 = –≤–µ–∫—Ç–æ—Ä—ã –ø–µ—Ä–ø–µ–Ω–¥–∏–∫—É–ª—è—Ä–Ω—ã (–Ω–µ—Ç –æ–±—â–∏—Ö —Å–ª–æ–≤)
- 1 = –≤–µ–∫—Ç–æ—Ä—ã –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã (–∏–¥–µ–Ω—Ç–∏—á–Ω—ã–µ)
- 0.8 = —É–≥–æ–ª ~36¬∞ (–æ—á–µ–Ω—å –ø–æ—Ö–æ–∂–∏–µ)
- 0.5 = —É–≥–æ–ª ~60¬∞ (—É–º–µ—Ä–µ–Ω–Ω–æ –ø–æ—Ö–æ–∂–∏–µ)

---

## üí° –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ—Ä–æ–≥–æ–≤ (–¥–ª—è –∞–¥–º–∏–Ω–∞)

### –í –∫–æ–¥–µ –º–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å:

**`engine_single.py`:**
```python
min_similarity_threshold = 0.25  # –ú–∏–Ω–∏–º—É–º 25%
max_df_ratio = 0.3               # –§–∏–ª—å—Ç—Ä —á–∞—Å—Ç—ã—Ö —Å–ª–æ–≤ (30%)
min_keywords_per_channel = 4     # –ú–∏–Ω–∏–º—É–º –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤
```

**–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è:**

| –¶–µ–ª—å | min_threshold | max_df_ratio | min_keywords |
|------|---------------|--------------|--------------|
| **–°—Ç—Ä–æ–≥–∏–π –ø–æ–¥–±–æ—Ä** | 0.40 (40%) | 0.2 | 6 |
| **–°–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π** | 0.25 (25%) | 0.3 | 4 |
| **–®–∏—Ä–æ–∫–∏–π –ø–æ–¥–±–æ—Ä** | 0.15 (15%) | 0.4 | 3 |

---

## üìù Changelog

### v2.3 (13 –¥–µ–∫–∞–±—Ä—è 2025)

**–ò–∑–º–µ–Ω–µ–Ω–æ:**
1. ‚úÖ –ê–±—Å–æ–ª—é—Ç–Ω–∞—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è score (–≤–º–µ—Å—Ç–æ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ–π)
2. ‚úÖ –ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π TF-IDF + Cosine Similarity
3. ‚úÖ –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –ø–æ—Ä–æ–≥ —Å—Ö–æ–∂–µ—Å—Ç–∏ 25%
4. ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ (min/max/avg)
5. ‚úÖ –£–¥–∞–ª–µ–Ω –∫–æ–¥ —Ä–∞—Å—á—ë—Ç–∞ max_score

**–§–∞–π–ª—ã:**
- `app/services/similarity_engine/engine_single.py`
- `app/services/xlsx_generator.py`

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ä–µ–∞–ª—å–Ω–∞—è —Å—Ö–æ–∂–µ—Å—Ç—å (–Ω–µ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–∞—è)
- –ö–∞—á–µ—Å—Ç–≤–æ –ø–æ–¥–±–æ—Ä–∞ –≤—ã—à–µ
- –ú–µ–Ω—å—à–µ —Å–ª–∞–±–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö –∫–∞–Ω–∞–ª–æ–≤

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### 1. –ë—ã—Å—Ç—Ä—ã–π —Ç–µ—Å—Ç (–Ω–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑)

```bash
# –í Telegram:
1. –û—Ç–ø—Ä–∞–≤—å –±–æ—Ç—É –∫–∞–Ω–∞–ª
2. –í—ã–±–µ—Ä–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 10)
3. –ü–æ–ª—É—á–∏ –æ—Ç—á—ë—Ç
4. –ü—Ä–æ–≤–µ—Ä—å –ø—Ä–æ—Ü–µ–Ω—Ç—ã —Å—Ö–æ–∂–µ—Å—Ç–∏
```

**–û–∂–∏–¥–∞–µ–º–æ–µ:**
- –ü—Ä–æ—Ü–µ–Ω—Ç—ã —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–µ (–Ω–µ –≤—Å–µ 90-100%)
- –ü–µ—Ä–≤—ã–π: 50-80% (–ª—É—á—à–∏–π)
- –ü–æ—Å–ª–µ–¥–Ω–∏–π: 25-35% (–º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –ø–æ—Ä–æ–≥)

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤

```bash
tail -f logs/bot.log | grep "ENGINE_SINGLE stats"
```

**–ü—Ä–∏–º–µ—Ä:**
```
ENGINE_SINGLE stats: found=47, min=0.267 (26.7%), max=0.824 (82.4%), avg=0.485 (48.5%)
```

**–†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞:**
- –ù–∞–π–¥–µ–Ω–æ 47 –∫–∞–Ω–∞–ª–æ–≤ —Å —Å—Ö–æ–∂–µ—Å—Ç—å—é > 25%
- –ú–∞–∫—Å–∏–º—É–º 82.4% (—Ä–µ–∞–ª—å–Ω–æ, –Ω–µ 100%!)
- –°—Ä–µ–¥–Ω—è—è 48.5%

### 3. –°—Ä–∞–≤–Ω–µ–Ω–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ –∫–∞–Ω–∞–ª –î–û –∏ –ü–û–°–õ–ï –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:

**–î–æ (–æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–∞—è):**
- –¢–æ–ø-1: 100% (–Ω–∞ —Å–∞–º–æ–º –¥–µ–ª–µ 0.6)
- –¢–æ–ø-5: 85% (–Ω–∞ —Å–∞–º–æ–º –¥–µ–ª–µ 0.5)
- –¢–æ–ø-10: 60% (–Ω–∞ —Å–∞–º–æ–º –¥–µ–ª–µ 0.36)

**–ü–æ—Å–ª–µ (–∞–±—Å–æ–ª—é—Ç–Ω–∞—è):**
- –¢–æ–ø-1: 60% (—Ä–µ–∞–ª—å–Ω–æ 0.6) ‚úÖ
- –¢–æ–ø-5: 50% (—Ä–µ–∞–ª—å–Ω–æ 0.5) ‚úÖ
- –¢–æ–ø-10: 36% (—Ä–µ–∞–ª—å–Ω–æ 0.36) ‚úÖ

---

## üéØ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è —Ä–µ–∫–ª–∞–º–æ–¥–∞—Ç–µ–ª–µ–π

### –ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤ —Å—Ö–æ–∂–µ—Å—Ç–∏:

| –î–∏–∞–ø–∞–∑–æ–Ω | –ó–Ω–∞—á–µ–Ω–∏–µ | –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è |
|----------|----------|--------------|
| **80-100%** | –û—á–µ–Ω—å –ø–æ—Ö–æ–∂–∏–µ | ‚úÖ –û—Ç–ª–∏—á–Ω—ã–π –≤—ã–±–æ—Ä –¥–ª—è —Ä–µ–∫–ª–∞–º—ã |
| **60-80%** | –ü–æ—Ö–æ–∂–∏–µ | ‚úÖ –•–æ—Ä–æ—à–∏–π –≤—ã–±–æ—Ä |
| **40-60%** | –£–º–µ—Ä–µ–Ω–Ω–æ –ø–æ—Ö–æ–∂–∏–µ | ‚ö†Ô∏è –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Ä—É—á–Ω—É—é |
| **25-40%** | –°–ª–∞–±–æ –ø–æ—Ö–æ–∂–∏–µ | ‚ö†Ô∏è –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ—Ç –ª—É—á—à–∏—Ö |
| **<25%** | –ù–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ | ‚ùå –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è |

### –ß—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç —Å—Ö–æ–∂–µ—Å—Ç—å:

**80%+** - –ö–∞–Ω–∞–ª—ã –∏–º–µ—é—Ç:
- –ü–æ—Ö–æ–∂—É—é –∞—É–¥–∏—Ç–æ—Ä–∏—é (–≤–æ–∑—Ä–∞—Å—Ç, –∏–Ω—Ç–µ—Ä–µ—Å—ã, –±–æ–ª–∏)
- –û–±—â–∏–µ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ (60%+)
- –°—Ö–æ–∂–∏–π tone of voice
- –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: **–û—Ç–ª–∏—á–Ω—ã–π –≤—ã–±–æ—Ä** –¥–ª—è —Ä–µ–∫–ª–∞–º—ã

**60-80%** - –ö–∞–Ω–∞–ª—ã –∏–º–µ—é—Ç:
- –ß–∞—Å—Ç–∏—á–Ω–æ —Å–æ–≤–ø–∞–¥–∞—é—â—É—é –∞—É–¥–∏—Ç–æ—Ä–∏—é
- –û–±—â–∏–µ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ (40-60%)
- –°—Ö–æ–∂—É—é —Ç–µ–º–∞—Ç–∏–∫—É
- –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: **–•–æ—Ä–æ—à–∏–π –≤—ã–±–æ—Ä**

**40-60%** - –ö–∞–Ω–∞–ª—ã –∏–º–µ—é—Ç:
- –ù–µ–∫–æ—Ç–æ—Ä—ã–µ –æ–±—â–∏–µ —Ç–µ–º—ã
- –û–±—â–∏–µ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ (20-40%)
- –ú–æ–∂–µ—Ç –Ω–µ —Å–æ–≤–ø–∞–¥–∞—Ç—å –∞—É–¥–∏—Ç–æ—Ä–∏—è
- –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞ –≤—Ä—É—á–Ω—É—é**

**25-40%** - –ö–∞–Ω–∞–ª—ã –∏–º–µ—é—Ç:
- –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ —Ç–µ–º
- –ú–∞–ª–æ –æ–±—â–∏—Ö —Å–ª–æ–≤
- –ú–æ–∂–µ—Ç –±—ã—Ç—å —Å–æ–≤—Å–µ–º –¥—Ä—É–≥–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è
- –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ—Ç –ª—É—á—à–∏—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤**

---

## üîß –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

### –ò–∑–º–µ–Ω–∏—Ç—å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –ø–æ—Ä–æ–≥

**–î–ª—è –±–æ–ª–µ–µ —Å—Ç—Ä–æ–≥–æ–≥–æ –ø–æ–¥–±–æ—Ä–∞:**

–û—Ç–∫—Ä–æ–π `app/services/similarity_engine/engine_single.py` –∏ –∏–∑–º–µ–Ω–∏:

```python
async def calculate_similarity_for_channel(
    target_channel_id: int,
    top_n: int = 10,
    max_df_ratio: float = 0.3,
    min_keywords_per_channel: int = 4,
    min_similarity_threshold: float = 0.40,  # –ò–∑–º–µ–Ω–µ–Ω–æ: 0.25 ‚Üí 0.40 (40%)
) -> bool:
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ü–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –∫–∞–Ω–∞–ª—ã —Å —Å—Ö–æ–∂–µ—Å—Ç—å—é > 40%

---

### –ò–∑–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä —á–∞—Å—Ç—ã—Ö —Å–ª–æ–≤

```python
max_df_ratio: float = 0.2,  # –ë—ã–ª–æ 0.3 ‚Üí —Å—Ç–∞–ª–æ 0.2 (20%)
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ë–æ–ª–µ–µ —Å—Ç—Ä–æ–≥–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –æ–±—â–∏—Ö —Å–ª–æ–≤ ("–Ω–æ–≤–æ—Å—Ç–∏", "–∫–∞–Ω–∞–ª", etc)

---

### –ò–∑–º–µ–Ω–∏—Ç—å –º–∏–Ω–∏–º—É–º –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤

```python
min_keywords_per_channel: int = 6,  # –ë—ã–ª–æ 4 ‚Üí —Å—Ç–∞–ª–æ 6
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ö–∞–Ω–∞–ª—ã —Å <6 –∫–ª—é—á–µ–≤—ã–º–∏ —Å–ª–æ–≤–∞–º–∏ –∏–≥–Ω–æ—Ä–∏—Ä—É—é—Ç—Å—è

---

## üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∞–ª–≥–æ—Ä–∏—Ç–º–∞

### –¢–µ–∫—É—â–∏–π –∞–ª–≥–æ—Ä–∏—Ç–º (–ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è)

```
1. –ó–∞–≥—Ä—É–∑–∫–∞ keywords –≤—Å–µ—Ö –∫–∞–Ω–∞–ª–æ–≤
   ‚Üì
2. –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è noise-–∫–∞–Ω–∞–ª–æ–≤
   ‚Üì
3. –†–∞—Å—á—ë—Ç IDF (inverse document frequency)
   ‚Üì
4. –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —á–∞—Å—Ç—ã—Ö —Å–ª–æ–≤ (max_df_ratio = 30%)
   ‚Üì
5. –î–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞:
   - –†–∞—Å—á—ë—Ç TF (term frequency)
   - –†–∞—Å—á—ë—Ç TF-IDF –≤–µ–∫—Ç–æ—Ä–æ–≤
   - –ö–æ—Å–∏–Ω—É—Å–Ω–æ–µ —Å—Ö–æ–¥—Å—Ç–≤–æ
   - –§–∏–ª—å—Ç—Ä –ø–æ –ø–æ—Ä–æ–≥—É (min 25%)
   ‚Üì
6. –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ score (desc)
   ‚Üì
7. –¢–æ–ø-N –∫–∞–Ω–∞–ª–æ–≤
   ‚Üì
8. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î
```

### Score –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è

```python
score = cosine_similarity(target_tfidf_vector, candidate_tfidf_vector)

# score ‚àà [0, 1]
# –≥–¥–µ:
# 1.0 = –∏–¥–µ–Ω—Ç–∏—á–Ω—ã–µ –∫–∞–Ω–∞–ª—ã (100%)
# 0.8 = –æ—á–µ–Ω—å –ø–æ—Ö–æ–∂–∏–µ (80%)
# 0.5 = —É–º–µ—Ä–µ–Ω–Ω–æ –ø–æ—Ö–æ–∂–∏–µ (50%)
# 0.25 = –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –ø–æ—Ä–æ–≥ (25%)
# 0.0 = –Ω–µ—Ç –æ–±—â–∏—Ö —Å–ª–æ–≤ (0%)
```

---

## üéâ –†–µ–∑—É–ª—å—Ç–∞—Ç

### –ß—Ç–æ —É–ª—É—á—à–∏–ª–æ—Å—å:

‚úÖ **–ß–µ—Å—Ç–Ω—ã–µ –ø—Ä–æ—Ü–µ–Ω—Ç—ã** - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ä–µ–∞–ª—å–Ω–∞—è —Å—Ö–æ–∂–µ—Å—Ç—å  
‚úÖ **–¢–æ—á–Ω—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º** - –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π TF-IDF + Cosine  
‚úÖ **–§–∏–ª—å—Ç—Ä —Å–ª–∞–±—ã—Ö** - –º–∏–Ω–∏–º—É–º 25% –ø–æ—Ä–æ–≥  
‚úÖ **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** - –≤–∏–¥–Ω–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –≤ –ª–æ–≥–∞—Ö  
‚úÖ **–ö–∞—á–µ—Å—Ç–≤–æ –ø–æ–¥–±–æ—Ä–∞** - —Ç–æ–ª—å–∫–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ –∫–∞–Ω–∞–ª—ã

### –î–ª—è —Ä–µ–∫–ª–∞–º–æ–¥–∞—Ç–µ–ª–µ–π:

‚úÖ –ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å - –≤–∏–¥–Ω–æ —Ä–µ–∞–ª—å–Ω—ã–µ –ø—Ä–æ—Ü–µ–Ω—Ç—ã  
‚úÖ –î–æ–≤–µ—Ä–∏–µ - 80% –∑–Ω–∞—á–∏—Ç 80%, –∞ –Ω–µ "–ª—É—á—à–∏–π –∏–∑ –ø–ª–æ—Ö–∏—Ö"  
‚úÖ –ö–∞—á–µ—Å—Ç–≤–æ - –º–µ–Ω—å—à–µ "–º—É—Å–æ—Ä–∞" –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö  
‚úÖ ROI - –ª—É—á—à–µ –∫–æ–Ω–≤–µ—Ä—Å–∏—è —Ä–µ–∫–ª–∞–º—ã (—Ç–æ—á–Ω–µ–µ –ø–æ–¥–±–æ—Ä)

---

## üèÜ Achievement Unlocked

```
‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà
‚ñà                                          ‚ñà
‚ñà     üéØ SIMILARITY ENGINE v2.3 üéØ         ‚ñà
‚ñà                                          ‚ñà
‚ñà  ‚úÖ –ê–±—Å–æ–ª—é—Ç–Ω–∞—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è              ‚ñà
‚ñà  ‚úÖ –ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π TF-IDF + Cosine          ‚ñà
‚ñà  ‚úÖ –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –ø–æ—Ä–æ–≥ 25%                ‚ñà
‚ñà  ‚úÖ –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ                ‚ñà
‚ñà  ‚úÖ –ß–µ—Å—Ç–Ω—ã–µ –ø—Ä–æ—Ü–µ–Ω—Ç—ã —Å—Ö–æ–∂–µ—Å—Ç–∏            ‚ñà
‚ñà                                          ‚ñà
‚ñà         Quality First! üéâ                ‚ñà
‚ñà                                          ‚ñà
‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà
```

---

**–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏ –±–æ—Ç–∞: `sudo systemctl restart orbita-bot`**

*–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: 13 –¥–µ–∫–∞–±—Ä—è 2025*

