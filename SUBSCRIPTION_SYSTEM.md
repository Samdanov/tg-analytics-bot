# –°–∏—Å—Ç–µ–º–∞ –ø–æ–¥–ø–∏—Å–æ–∫ –∏ –ª–∏–º–∏—Ç–æ–≤

## –û–±–∑–æ—Ä

–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –¥–ª—è –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö –∏ –ø–ª–∞—Ç–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:

### üÜì –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π —Ç–∞—Ä–∏—Ñ (Free)
- **10 –∑–∞–ø—Ä–æ—Å–æ–≤** –Ω–∞ –∞–Ω–∞–ª–∏–∑
- **–î–æ 100 –∫–∞–Ω–∞–ª–æ–≤** –≤ –æ—Ç—á–µ—Ç–µ
- –í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –±–æ—Ç–∞

### üíé Premium —Ç–∞—Ä–∏—Ñ
- **–ë–µ–∑–ª–∏–º–∏—Ç–Ω—ã–µ** –∑–∞–ø—Ä–æ—Å—ã
- **–î–æ 500 –∫–∞–Ω–∞–ª–æ–≤** –≤ –æ—Ç—á–µ—Ç–µ
- –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞

### üëë Admin
- **–ë–µ–∑–ª–∏–º–∏—Ç–Ω—ã–µ** –∑–∞–ø—Ä–æ—Å—ã
- **–î–æ 500 –∫–∞–Ω–∞–ª–æ–≤** –≤ –æ—Ç—á–µ—Ç–µ
- –î–æ—Å—Ç—É–ø –∫ admin –∫–æ–º–∞–Ω–¥–∞–º

## –£—Å—Ç–∞–Ω–æ–≤–∫–∞

### –®–∞–≥ 1: –ó–∞–ø—É—Å—Ç–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é

```bash
cd /home/alex/apps/tg-analytics-bot
python3 scripts/migrate_add_users_table.py
```

–≠—Ç–æ —Å–æ–∑–¥–∞—Å—Ç —Ç–∞–±–ª–∏—Ü—É `users` –≤ –ë–î.

### –®–∞–≥ 2: –î–æ–±–∞–≤–∏—Ç—å —Å–µ–±—è –≤ –∞–¥–º–∏–Ω—ã

–û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ —Ñ–∞–π–ª `app/bot/handlers/subscription.py`:

```python
ADMIN_IDS = [
    123456789,  # –í–∞—à Telegram ID
]
```

**–ö–∞–∫ —É–∑–Ω–∞—Ç—å —Å–≤–æ–π Telegram ID:**
1. –ù–∞–ø–∏—à–∏—Ç–µ –±–æ—Ç—É @userinfobot
2. –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ /stats –≤ –≤–∞—à–µ–º –±–æ—Ç–µ (–ø–æ–∫–∞–∂–µ—Ç –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞)

### –®–∞–≥ 3: –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞

```bash
# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–æ—Ç–∞ (Ctrl+C –∏–ª–∏ —á–µ—Ä–µ–∑ systemd)
sudo systemctl restart orbita-bot

# –ò–ª–∏ –≤—Ä—É—á–Ω—É—é
cd /home/alex/apps/tg-analytics-bot
source venv/bin/activate
python3 app/main_di.py
```

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –î–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

#### `/start`
–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –ª–∏–º–∏—Ç–∞—Ö.

#### `/stats`
–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
- –¢–∏–ø –ø–æ–¥–ø–∏—Å–∫–∏
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ –∑–∞–ø—Ä–æ—Å–æ–≤ / –õ–∏–º–∏—Ç
- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∞–Ω–∞–ª–æ–≤
- –î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏

–ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞:
```
üåå –í–∞—à–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: @username
üÜì –ü–æ–¥–ø–∏—Å–∫–∞: FREE
üìÖ –î–µ–π—Å—Ç–≤—É–µ—Ç –¥–æ: ‚Äî

üìä –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
‚Ä¢ –ó–∞–ø—Ä–æ—Å–æ–≤: 3 / 10
‚Ä¢ –ú–∞–∫—Å. –∫–∞–Ω–∞–ª–æ–≤: 100

üìÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è: 21.12.2025

üíé –•–æ—Ç–∏—Ç–µ –±–æ–ª—å—à–µ?
–ü–æ–ª—É—á–∏—Ç–µ Premium:
‚Ä¢ –ë–µ–∑–ª–∏–º–∏—Ç–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
‚Ä¢ –î–æ 500 –∫–∞–Ω–∞–ª–æ–≤ –≤ –æ—Ç—á–µ—Ç–µ
‚Ä¢ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞
```

### –î–ª—è –∞–¥–º–∏–Ω–æ–≤

#### `/admin_help`
–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–ø–∏—Å–æ–∫ admin –∫–æ–º–∞–Ω–¥.

#### `/admin_grant <user_id> <type> [days]`
–í—ã–¥–∞–µ—Ç –ø–æ–¥–ø–∏—Å–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.

**–ü—Ä–∏–º–µ—Ä—ã:**
```bash
# Premium –Ω–∞ 30 –¥–Ω–µ–π
/admin_grant 123456789 premium 30

# Admin –Ω–∞–≤—Å–µ–≥–¥–∞
/admin_grant 987654321 admin

# –í–µ—Ä–Ω—É—Ç—å –Ω–∞ free
/admin_grant 123456789 free
```

**–¢–∏–ø—ã –ø–æ–¥–ø–∏—Å–æ–∫:**
- `free` - –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π (10 –∑–∞–ø—Ä–æ—Å–æ–≤, 100 –∫–∞–Ω–∞–ª–æ–≤)
- `premium` - –ø–ª–∞—Ç–Ω—ã–π (–±–µ–∑–ª–∏–º–∏—Ç, 500 –∫–∞–Ω–∞–ª–æ–≤)
- `admin` - –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä (–±–µ–∑–ª–∏–º–∏—Ç, 500 –∫–∞–Ω–∞–ª–æ–≤)

#### `/admin_reset <user_id>`
–°–±—Ä–∞—Å—ã–≤–∞–µ—Ç —Å—á–µ—Ç—á–∏–∫ –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

**–ü—Ä–∏–º–µ—Ä:**
```bash
/admin_reset 123456789
```

#### `/admin_info <user_id>`
–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–æ–ª–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ.

**–ü—Ä–∏–º–µ—Ä:**
```bash
/admin_info 123456789
```

–í—ã–¥–∞–µ—Ç:
```
üë§ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ

ID: 123456789
Username: @username
–ü–æ–¥–ø–∏—Å–∫–∞: PREMIUM
–î–µ–π—Å—Ç–≤—É–µ—Ç –¥–æ: 20.01.2026 12:30

–ó–∞–ø—Ä–æ—Å–æ–≤: 45 / ‚àû (–±–µ–∑–ª–∏–º–∏—Ç)
–ú–∞–∫—Å. –∫–∞–Ω–∞–ª–æ–≤: 500

–°—Ç–∞—Ç—É—Å: ‚úÖ –ê–∫—Ç–∏–≤–µ–Ω
–ó–∞–±–∞–Ω–µ–Ω: ‚úÖ –ù–µ—Ç

–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è: 21.12.2025 10:15
```

## –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è

–ü—Ä–∏ –ø–µ—Ä–≤–æ–º –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ –±–æ—Ç—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç—Å—è —Å —Ç–∏–ø–æ–º `free`:
- `queries_limit` = 10
- `queries_used` = 0
- `max_channels` = 100

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–æ–≤

**Middleware `SubscriptionMiddleware`** –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ª–∏–º–∏—Ç—ã –ø–µ—Ä–µ–¥ –∫–∞–∂–¥—ã–º –∑–∞–ø—Ä–æ—Å–æ–º –Ω–∞ –∞–Ω–∞–ª–∏–∑:

1. –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç/–æ–±–Ω–æ–≤–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
2. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –Ω–µ –∑–∞–±–∞–Ω–µ–Ω –ª–∏
3. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤
4. –ë–ª–æ–∫–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å –µ—Å–ª–∏ –ª–∏–º–∏—Ç –∏—Å—á–µ—Ä–ø–∞–Ω

### –£—á–µ—Ç –∑–∞–ø—Ä–æ—Å–æ–≤

–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ –∞–Ω–∞–ª–∏–∑–∞:
- `queries_used` —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è –Ω–∞ 1
- `last_activity_at` –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è

### –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∫–∞–Ω–∞–ª–æ–≤

–ü—Ä–∏ –≤–≤–æ–¥–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∫–∞–Ω–∞–ª–æ–≤:
- **Free:** –º–∞–∫—Å–∏–º—É–º 100 –∫–∞–Ω–∞–ª–æ–≤
- **Premium:** –º–∞–∫—Å–∏–º—É–º 500 –∫–∞–Ω–∞–ª–æ–≤

–ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç –±–æ–ª—å—à–µ ‚Üí –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç—Å—è –¥–æ –º–∞–∫—Å–∏–º—É–º–∞.

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ë–î

### –¢–∞–±–ª–∏—Ü–∞ `users`

```sql
CREATE TABLE users (
    user_id INTEGER PRIMARY KEY,        -- Telegram user ID
    username TEXT,                       -- Telegram username
    first_name TEXT,                     -- –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    
    subscription_type TEXT DEFAULT 'free',  -- –¢–∏–ø –ø–æ–¥–ø–∏—Å–∫–∏
    subscription_expires_at TIMESTAMP,   -- –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è
    
    queries_used INTEGER DEFAULT 0,      -- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ –∑–∞–ø—Ä–æ—Å–æ–≤
    queries_limit INTEGER DEFAULT 10,    -- –õ–∏–º–∏—Ç (-1 = –±–µ–∑–ª–∏–º–∏—Ç)
    queries_reset_at TIMESTAMP,          -- –î–∞—Ç–∞ —Å–±—Ä–æ—Å–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
    
    is_active BOOLEAN DEFAULT TRUE,      -- –ê–∫—Ç–∏–≤–µ–Ω –ª–∏
    is_banned BOOLEAN DEFAULT FALSE,     -- –ó–∞–±–∞–Ω–µ–Ω –ª–∏
    
    created_at TIMESTAMP,                -- –î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
    last_activity_at TIMESTAMP,          -- –ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
    
    notes TEXT                           -- –ó–∞–º–µ—Ç–∫–∏ –∞–¥–º–∏–Ω–∞
);
```

### –ò–Ω–¥–µ–∫—Å—ã

```sql
CREATE INDEX idx_users_subscription_type ON users(subscription_type);
CREATE INDEX idx_users_is_active ON users(is_active);
```

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

**1. Model (`app/db/models.py`)**
- –ú–æ–¥–µ–ª—å `User` –¥–ª—è ORM
- –ü–æ–ª—è –¥–ª—è –ø–æ–¥–ø–∏—Å–∫–∏, –ª–∏–º–∏—Ç–æ–≤, —Å—Ç–∞—Ç—É—Å–∞

**2. Service (`app/services/user_service.py`)**
- `UserService` - –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞
- –ú–µ—Ç–æ–¥—ã: —Å–æ–∑–¥–∞–Ω–∏–µ, –ø—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–æ–≤, —É—á–µ—Ç –∑–∞–ø—Ä–æ—Å–æ–≤

**3. Middleware (`app/bot/middlewares/subscription.py`)**
- `SubscriptionMiddleware` - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
- –ü—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫–æ –≤—Å–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è–º –∏ callback

**4. Handlers (`app/bot/handlers/subscription.py`)**
- –ö–æ–º–∞–Ω–¥—ã `/stats`, `/admin_*`
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∞–º–∏

**5. Integration (`app/main_di.py`)**
- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ middleware –∏ router
- –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞ `/start`

**6. Workflow (`app/bot/handlers/workflow_di.py`)**
- –£—á–µ—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ—Å–ª–µ –∞–Ω–∞–ª–∏–∑–∞
- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ top_n –¥–ª—è free –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

## –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ø–ª–∞—Ç–µ–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º–æ–π

### –ì–æ—Ç–æ–≤–∞—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞

–°–∏—Å—Ç–µ–º–∞ **–≥–æ—Ç–æ–≤–∞** –∫ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å –ª—é–±–æ–π –ø–ª–∞—Ç–µ–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º–æ–π:
- YooKassa (–Æ–∫–∞—Å—Å–∞)
- Stripe
- Telegram Stars
- PayPal
- –ö—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç—ã

### –ß—Ç–æ –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å

1. **Handler –¥–ª—è –æ–ø–ª–∞—Ç—ã**
   ```python
   # app/bot/handlers/payment.py
   
   @router.message(Command("buy_premium"))
   async def buy_premium_handler(message: Message):
       # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—Å—ã–ª–∫–∏ –Ω–∞ –æ–ø–ª–∞—Ç—É
       payment_url = create_payment(user_id, amount=990)
       await message.answer(f"–û–ø–ª–∞—Ç–∏—Ç–µ –ø–æ —Å—Å—ã–ª–∫–µ: {payment_url}")
   
   @router.message(F.successful_payment)
   async def successful_payment_handler(message: Message):
       # –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã
       await UserService.set_subscription(
           user_id=message.from_user.id,
           subscription_type="premium",
           expires_at=datetime.utcnow() + timedelta(days=30)
       )
       await message.answer("‚úÖ Premium –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω!")
   ```

2. **Webhook –¥–ª—è –ø–ª–∞—Ç–µ–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã**
   ```python
   # app/api/payment_webhook.py
   
   @app.post("/webhook/payment")
   async def payment_webhook(data: dict):
       # –û–±—Ä–∞–±–æ—Ç–∫–∞ callback –æ—Ç –ø–ª–∞—Ç–µ–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã
       if data["status"] == "success":
           await UserService.set_subscription(
               user_id=data["user_id"],
               subscription_type="premium",
               expires_at=datetime.utcnow() + timedelta(days=30)
           )
   ```

3. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏**
   ```python
   # app/tasks/check_subscriptions.py
   
   async def check_expired_subscriptions():
       # –†–∞–∑ –≤ —á–∞—Å –ø—Ä–æ–≤–µ—Ä—è–µ–º –∏—Å—Ç–µ–∫—à–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏
       expired_users = await get_expired_premium_users()
       for user in expired_users:
           await UserService.set_subscription(
               user_id=user.user_id,
               subscription_type="free"
           )
   ```

## –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –ü—Ä–∏–º–µ—Ä 1: –í—ã–¥–∞—Ç—å Premium –Ω–∞ –º–µ—Å—è—Ü

```bash
# –í –±–æ—Ç–µ (–æ—Ç –∞–¥–º–∏–Ω–∞)
/admin_grant 123456789 premium 30
```

### –ü—Ä–∏–º–µ—Ä 2: –°–±—Ä–æ—Å–∏—Ç—å –ª–∏–º–∏—Ç –±–µ—Å–ø–ª–∞—Ç–Ω–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é

```bash
/admin_reset 123456789
```

### –ü—Ä–∏–º–µ—Ä 3: –ó–∞–±–∞–Ω–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

```python
# –ß–µ—Ä–µ–∑ –ë–î (–ø–æ–∫–∞ –Ω–µ—Ç –∫–æ–º–∞–Ω–¥—ã)
from app.services.user_service import UserService

async def ban_user(user_id: int):
    async with async_session_maker() as session:
        await session.execute(
            update(User)
            .where(User.user_id == user_id)
            .values(is_banned=True)
        )
        await session.commit()
```

### –ü—Ä–∏–º–µ—Ä 4: –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º

```python
# –°–∫—Ä–∏–ø—Ç –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
from sqlalchemy import select, func
from app.db.models import User

async def get_stats():
    async with async_session_maker() as session:
        result = await session.execute(
            select(
                User.subscription_type,
                func.count(User.user_id)
            ).group_by(User.subscription_type)
        )
        for sub_type, count in result:
            print(f"{sub_type}: {count} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π")
```

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### 1. –¢–µ—Å—Ç –±–µ—Å–ø–ª–∞—Ç–Ω–æ–≥–æ –ª–∏–º–∏—Ç–∞

1. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å –≤ –±–æ—Ç–µ (–æ—Ç–ø—Ä–∞–≤—å—Ç–µ /start)
2. –°–¥–µ–ª–∞–π—Ç–µ 10 –∞–Ω–∞–ª–∏–∑–æ–≤
3. –ù–∞ 11-–º –¥–æ–ª–∂–Ω–æ –ø–æ—è–≤–∏—Ç—å—Å—è —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –ª–∏–º–∏—Ç–µ

### 2. –¢–µ—Å—Ç Premium

1. –í—ã–¥–∞–π—Ç–µ —Å–µ–±–µ Premium: `/admin_grant <–≤–∞—à_id> premium 30`
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ /stats - –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å "–±–µ–∑–ª–∏–º–∏—Ç"
3. –°–¥–µ–ª–∞–π—Ç–µ 20+ –∞–Ω–∞–ª–∏–∑–æ–≤ - –≤—Å–µ –¥–æ–ª–∂–Ω—ã —Ä–∞–±–æ—Ç–∞—Ç—å

### 3. –¢–µ—Å—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∫–∞–Ω–∞–ª–æ–≤

1. –ö–∞–∫ Free –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ø—Ä–æ—Å–∏—Ç–µ 200 –∫–∞–Ω–∞–ª–æ–≤
2. –î–æ–ª–∂–Ω–æ –ø–æ—è–≤–∏—Ç—å—Å—è —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–∞
3. –û—Ç—á–µ—Ç –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å 100 –∫–∞–Ω–∞–ª–æ–≤ (–Ω–µ 200)

## FAQ

**Q: –ö–∞–∫ –∏–∑–º–µ–Ω–∏—Ç—å –ª–∏–º–∏—Ç—ã?**
A: –í —Ñ–∞–π–ª–µ `app/services/user_service.py`:
```python
FREE_QUERIES_LIMIT = 10  # –ò–∑–º–µ–Ω–∏—Ç—å –Ω–∞ –Ω—É–∂–Ω–æ–µ —á–∏—Å–ª–æ
FREE_MAX_CHANNELS = 100
```

**Q: –ú–æ–∂–Ω–æ –ª–∏ —Å–¥–µ–ª–∞—Ç—å –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–π —Å–±—Ä–æ—Å –ª–∏–º–∏—Ç–∞?**
A: –î–∞, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–æ–ª–µ `queries_reset_at` –∏ —Å–æ–∑–¥–∞–π—Ç–µ –∑–∞–¥–∞—á—É –≤ cron:
```python
# –ö–∞–∂–¥—ã–π –º–µ—Å—è—Ü 1-–≥–æ —á–∏—Å–ª–∞
if datetime.utcnow().day == 1:
    await UserService.reset_queries(user_id)
```

**Q: –ö–∞–∫ –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π —Ç–∏–ø –ø–æ–¥–ø–∏—Å–∫–∏?**
A: 
1. –î–æ–±–∞–≤—å—Ç–µ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã –≤ `user_service.py`
2. –û–±–Ω–æ–≤–∏—Ç–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤ `subscription.py`
3. –î–æ–±–∞–≤—å—Ç–µ –≤ admin –∫–æ–º–∞–Ω–¥—ã

**Q: –ì–¥–µ —Ö—Ä–∞–Ω—è—Ç—Å—è ID –∞–¥–º–∏–Ω–æ–≤?**
A: –í —Ñ–∞–π–ª–µ `app/bot/handlers/subscription.py`:
```python
ADMIN_IDS = [123456789]
```

**Q: –ú–æ–∂–Ω–æ –ª–∏ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π?**
A: –î–∞, —á–µ—Ä–µ–∑ –ë–î:
```sql
SELECT * FROM users ORDER BY created_at DESC LIMIT 100;
```

## Troubleshooting

### –ü—Ä–æ–±–ª–µ–º–∞: "–¢–∞–±–ª–∏—Ü–∞ users –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"

**–†–µ—à–µ–Ω–∏–µ:**
```bash
python3 scripts/migrate_add_users_table.py
```

### –ü—Ä–æ–±–ª–µ–º–∞: "Admin –∫–æ–º–∞–Ω–¥—ã –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç"

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –≤–∞—à ID –≤ `ADMIN_IDS`
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –±–æ—Ç –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π

### –ü—Ä–æ–±–ª–µ–º–∞: "–õ–∏–º–∏—Ç—ã –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç"

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ middleware –ø–æ–¥–∫–ª—é—á–µ–Ω –≤ `main_di.py`
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: `tail -f logs/bot.log`

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. ‚úÖ –ó–∞–ø—É—Å—Ç–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é
2. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å —Å–µ–±—è –≤ –∞–¥–º–∏–Ω—ã
3. ‚úÖ –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞
4. ‚úÖ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ª–∏–º–∏—Ç—ã
5. üîú –í—ã–±—Ä–∞—Ç—å –ø–ª–∞—Ç–µ–∂–Ω—É—é —Å–∏—Å—Ç–µ–º—É
6. üîú –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –æ–ø–ª–∞—Ç—É
7. üîú –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–æ–¥–ª–µ–Ω–∏–µ

## –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∫–æ–¥–∞

- **Models:** `app/db/models.py` ‚Üí –∫–ª–∞—Å—Å `User`
- **Service:** `app/services/user_service.py` ‚Üí –∫–ª–∞—Å—Å `UserService`
- **Middleware:** `app/bot/middlewares/subscription.py`
- **Handlers:** `app/bot/handlers/subscription.py`
- **Migration:** `scripts/migrate_add_users_table.py`
