# Архитектура и схема работы Telegram Analytics Bot

## Общая архитектура системы

```
┌─────────────────────────────────────────────────────────────────┐
│                         ПОЛЬЗОВАТЕЛЬ                            │
│                    (Telegram Bot Interface)                     │
└────────────────────────────┬────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────┐
│                    AIOGRAM DISPATCHER                           │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │  Middleware: IgnoreForbiddenMiddleware                   │   │
│  └──────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐           │
│  │   /start     │  │   /fetch     │  │  /add_channel│           │
│  └──────────────┘  └──────────────┘  └──────────────┘           │
│                                                                 │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐           │
│  │  /analyze    │  │  /export     │  │  workflow    │           │
│  └──────────────┘  └──────────────┘  └──────────────┘           │
└────────────────────────────┬────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────┐
│                    HANDLERS (app/bot/handlers/)                 │
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │  workflow.py (Основной обработчик)                       │   │
│  │  • detect_channel_handler()                              │   │
│  │  • start_analysis_callback()                             │   │
│  │  • force_analysis_callback()                             │   │
│  └──────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐           │
│  │  fetch.py    │  │ add_channel  │  │  analyze.py  │           │
│  └──────────────┘  └──────────────┘  └──────────────┘           │
└────────────────────────────┬────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────┐
│              SERVICES LAYER (app/services/)                     │
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │  workflow_pipeline.py                                    │   │
│  │  • run_full_analysis_pipeline()                          │   │
│  └──────────────────────────────────────────────────────────┘   │
└────────────────────────────┬────────────────────────────────────┘
                             │
                             ▼
                    ┌────────┴────────┐
                    │                 │
                    ▼                 ▼
        ┌──────────────────┐  ┌──────────────────┐
        │  Telethon Parser │  │  Database Repo   │
        │  (channel_info)  │  │  (save_channel)  │
        └──────────────────┘  └──────────────────┘
                    │                 │
                    └────────┬────────┘
                             ▼
        ┌──────────────────────────────────┐
        │      LLM Analyzer                │
        │  (analyze_channel)               │
        └──────────────────────────────────┘
                             │
                             ▼
        ┌──────────────────────────────────┐
        │   Similarity Engine              │
        │  (recalc_for_channel)            │
        └──────────────────────────────────┘
                             │
                             ▼
        ┌──────────────────────────────────┐
        │   XLSX Generator                 │
        │  (generate_similar_channels_xlsx)│
        └──────────────────────────────────┘
```

## Детальный flow анализа канала

### Этап 1: Получение сообщения от пользователя

```
Пользователь
    │
    ├─ Пересылает пост из канала
    ├─ Отправляет ссылку @channel
    └─ Отправляет текст с упоминанием канала
         │
         ▼
┌────────────────────────────────────────┐
│  detect_channel_handler()              │
│  (workflow.py)                         │
│                                        │
│  1. Извлечение канала из сообщения:    │
│     • forward_from_chat (пересланный)  │
│     • text/caption (ссылка/упоминание) │
│                                        │
│  2. Определение типа:                  │
│     • username (@channel)              │
│     • ID (-1002508742544)              │
│                                        │
│  3. Отображение кнопок выбора:         │
│     • 10, 25, 50, 100, 500 каналов     │
└────────────────────────────────────────┘
```

### Этап 2: Проверка на канал-прокладку

```
Пользователь нажимает кнопку
    │
    ▼
┌────────────────────────────────────────┐
│  start_analysis_callback()             │
│  (workflow.py)                         │
│                                        │
│  1. Получение постов канала            │
│     (get_channel_with_posts)           │
│                                        │
│  2. Проверка на прокладку:             │
│     • Извлечение ссылок на каналы      │
│     • Подсчёт текста (без ссылок)      │
│     • Проверка критериев:              │
│       - ≥3 уникальных каналов          │
│       - <100 символов текста/пост      │
│       - >50% постов со ссылками        │
│                                        │
│  3. Если прокладка:                    │
│     • Показать список найденных каналов│
│     • Позволить выбрать нужный         │
│                                        │
│  4. Если не прокладка:                 │
│     • Продолжить анализ                │
└────────────────────────────────────────┘
```

### Этап 3: Полный пайплайн анализа

```
┌─────────────────────────────────────────────────────────────┐
│  run_full_analysis_pipeline()                               │
│  (workflow_pipeline.py)                                     │
└─────────────────────────────────────────────────────────────┘
         │
         ├─► Шаг 1: Получение данных через Telethon
         │   ┌──────────────────────────────────────┐
         │   │ get_channel_with_posts()             │
         │   │ • Определение типа (ID/username)     │
         │   │ • client.get_entity()                │
         │   │ • Получение метаданных канала        │
         │   │ • Загрузка постов (limit=100)        │
         │   └──────────────────────────────────────┘
         │
         ├─► Шаг 2: Сохранение в БД
         │   ┌──────────────────────────────────────┐
         │   │ save_channel()                       │
         │   │ • UPSERT канала                      │
         │   │ • Для ID-based: "id:CHANNEL_ID"      │
         │   │ • Для username: "@channel"           │
         │   │                                      │
         │   │ save_posts()                         │
         │   │ • Удаление старых постов             │
         │   │ • Сохранение новых постов            │
         │   └──────────────────────────────────────┘
         │
         ├─► Шаг 3: LLM-анализ
         │   ┌──────────────────────────────────────┐
         │   │ analyze_channel()                    │
         │   │ • Очистка текста (удаление ссылок)   │
         │   │ • Формирование промпта               │
         │   │ • Запрос к OpenAI API                │
         │   │ • Извлечение keywords, audience, tone│
         │   │ • Нормализация ключевых слов         │
         │   │                                      │
         │   │ save_analysis()                      │
         │   │ • Сохранение в KeywordsCache         │
         │   └──────────────────────────────────────┘
         │
         ├─► Шаг 4: Расчёт похожих каналов
         │   ┌──────────────────────────────────────┐
         │   │ recalc_for_channel()                 │
         │   │ • Получение keywords канала          │
         │   │ • Поиск похожих каналов в БД         │
         │   │ • Расчёт similarity score            │
         │   │ • Сортировка по релевантности        │
         │   │ • Сохранение в AnalyticsResults      │
         │   └──────────────────────────────────────┘
         │
         └─► Шаг 5: Генерация отчёта
             ┌──────────────────────────────────────┐
             │ generate_similar_channels_xlsx()     │
             │ • Загрузка данных из БД              │
             │ • Формирование Excel файла           │
             │ • Автоподгонка ширины колонок        │
             │ • Сохранение в reports/              │
             └──────────────────────────────────────┘
```

### Этап 4: Отправка результатов пользователю

```
┌─────────────────────────────────────────────────────────────┐
│  start_analysis_callback() (продолжение)                    │
│                                                             │
│  1. build_channel_summary()                                 │
│     • Загрузка данных из БД                                 │
│     • Форматирование карточки канала                        │
│     • Отображение: subscribers, ЦА, keywords                │
│                                                             │
│  2. Отправка summary пользователю                           │
│                                                             │
│  3. Отправка Excel файла                                    │
│     • FSInputFile(report_path)                              │
│     • answer_document()                                     │
└─────────────────────────────────────────────────────────────┘
```

## Компоненты системы

### 1. Telegram Parser (Telethon)

```
┌────────────────────────────────────────┐
│  telegram_parser/                      │
│                                        │
│  • client.py                           │
│    - Инициализация Telethon клиента    │
│    - Управление сессией                │
│                                        │
│  • channel_info.py                     │
│    - get_channel_with_posts()          │
│    - Поддержка ID и username           │
│    - Получение метаданных и постов     │
└────────────────────────────────────────┘
```

### 2. LLM Analyzer

```
┌────────────────────────────────────────┐
│  llm/                                  │
│                                        │
│  • client.py                           │
│    - Запросы к OpenAI API              │
│                                        │
│  • prompt.py                           │
│    - Формирование промптов             │
│                                        │
│  • analyzer.py                         │
│    - analyze_channel()                 │
│    - Очистка текста                    │
│    - Нормализация keywords             │
│    - Сохранение результатов            │
└────────────────────────────────────────┘
```

### 3. Similarity Engine

```
┌────────────────────────────────────────┐
│  similarity_engine/                    │
│                                        │
│  • engine_single.py                    │
│    - recalc_for_channel()              │
│    - Поиск похожих каналов             │
│    - Расчёт similarity score           │
│                                        │
│  • shared.py                           │
│    - Общие функции                     │
└────────────────────────────────────────┘
```

### 4. Database Layer

```
┌────────────────────────────────────────┐
│  db/                                   │
│                                        │
│  • models.py                           │
│    - Channel                           │
│    - Post                              │
│    - KeywordsCache                     │
│    - AnalyticsResults                  │
│                                        │
│  • repo.py                             │
│    - save_channel()                    │
│    - save_posts()                      │
│    - get_channel_id_by_username()      │
└────────────────────────────────────────┘
```

### 5. XLSX Generator

```
┌────────────────────────────────────────┐
│  xlsx_generator.py                     │
│                                        │
│  • generate_similar_channels_xlsx()    │
│    - Загрузка данных из БД             │
│    - Формирование Excel через openpyxl │
│    - Автоподгонка колонок              │
│    - Сохранение файла                  │
└────────────────────────────────────────┘
```

## Обработка различных типов каналов

### Обычный канал (с @username)

```
Пользователь → @tech_news
    │
    ▼
detect_channel_handler()
    │
    ├─ identifier = "tech_news"
    ├─ is_id_based = False
    └─ Показывает: "@tech_news"
         │
         ▼
start_analysis_callback()
    │
    ├─ Проверка на прокладку
    └─ run_full_analysis_pipeline("tech_news")
         │
         ├─ get_channel_with_posts("tech_news")
         ├─ save_channel() → username="tech_news"
         ├─ LLM анализ
         ├─ Similarity engine
         └─ XLSX: report_tech_news.xlsx
```

### Приватный канал (без @username, по ID)

```
Пользователь → Пересылает пост из TERMINAL
    │
    ▼
detect_channel_handler()
    │
    ├─ identifier = "-1002508742544"
    ├─ is_id_based = True
    └─ Показывает: "ID: -1002508742544"
         │
         ▼
start_analysis_callback()
    │
    ├─ Пропуск проверки на прокладку (ID-based)
    └─ run_full_analysis_pipeline("-1002508742544")
         │
         ├─ get_channel_with_posts("-1002508742544")
         │   ├─ Определение: is_channel_id = True
         │   ├─ client.get_entity(-1002508742544)
         │   └─ Сохранение оригинального ID
         │
         ├─ save_channel() → username="id:-1002508742544"
         ├─ LLM анализ
         ├─ Similarity engine
         └─ XLSX: report_id:-1002508742544.xlsx
```

### Канал-прокладка

```
Пользователь → @proxy_channel
    │
    ▼
start_analysis_callback()
    │
    ├─ get_channel_with_posts("proxy_channel")
    ├─ Проверка на прокладку:
    │   ├─ Извлечение ссылок: @channel1, @channel2, ...
    │   ├─ Подсчёт текста: avg_text_per_post < 100
    │   └─ Доля постов со ссылками: > 50%
    │
    └─ Прокладка обнаружена!
         │
         ▼
Показывает список каналов:
    • @channel1 (15 упоминаний)
    • @channel2 (10 упоминаний)
    • @channel3 (5 упоминаний)
    • ⚠️ Все равно анализировать @proxy_channel
         │
         ▼
Пользователь выбирает @channel1
    │
    └─ run_full_analysis_pipeline("channel1")
```

## Потоки данных

### Поток 1: Сохранение канала

```
Telethon API
    │
    ├─ channel_data = {
    │     "id": -1002508742544,
    │     "username": None,
    │     "title": "TERMINAL",
    │     "about": "...",
    │     "participants_count": 1000
    │   }
    │
    ▼
save_channel()
    │
    ├─ username = None → channel_id_from_data = -1002508742544
    ├─ username = "id:-1002508742544"
    └─ UPSERT в БД
         │
         ▼
PostgreSQL
    │
    └─ channels table:
        id | username              | title   | subscribers
        1  | id:-1002508742544     | TERMINAL| 1000
```

### Поток 2: LLM анализ

```
channel_data + posts
    │
    ▼
analyze_channel()
    │
    ├─ clean_text() - удаление ссылок
    ├─ Формирование промпта
    ├─ Запрос к OpenAI API
    └─ Парсинг JSON ответа
         │
         ▼
result = {
    "keywords": ["python", "devops", ...],
    "audience": "Разработчики...",
    "tone": "Профессиональный"
}
    │
    ▼
save_analysis()
    │
    └─ Сохранение в KeywordsCache
```

### Поток 3: Поиск похожих каналов

```
Keywords канала: ["python", "devops", "docker"]
    │
    ▼
recalc_for_channel()
    │
    ├─ Загрузка всех каналов из БД
    ├─ Для каждого канала:
    │   ├─ Получение keywords
    │   ├─ Расчёт similarity (Jaccard/косинусное)
    │   └─ Сортировка по score
    │
    └─ Топ-N похожих каналов
         │
         ▼
AnalyticsResults
    │
    └─ similar_channels_json = [
        {"channel_id": 123, "score": 0.85},
        {"channel_id": 456, "score": 0.78},
        ...
      ]
```

## Обработка ошибок

```
┌────────────────────────────────────────┐
│  Error Handling Flow                   │
│                                        │
│  1. Telethon ошибки:                   │
│     • UsernameInvalidError             │
│     • ChannelPrivateError              │
│     • FloodWaitError                   │
│     → Возврат error message            │
│                                        │
│  2. БД ошибки:                         │
│     • IntegrityError (дубликат)        │
│     → UPSERT решает проблему           │
│                                        │
│  3. LLM ошибки:                        │
│     • Timeout                          │
│     • Invalid JSON                     │
│     → Fallback на keywords extraction  │
│                                        │
│  4. Middleware:                        │
│     • IgnoreForbiddenMiddleware        │
│     → Игнорирование заблокированных    │
└────────────────────────────────────────┘
```

## Кэширование и оптимизация

```
┌────────────────────────────────────────┐
│  Оптимизации                           │
│                                        │
│  1. Media Group Cache:                 │
│     • Дедупликация альбомов            │
│     • TTL: 60 секунд                   │
│                                        │
│  2. Telethon Client:                   │
│     • Переиспользование сессии         │
│     • Retry механизм                   │
│                                        │
│  3. БД:                                │
│     • UPSERT для каналов               │
│     • Индексы на username              │
└────────────────────────────────────────┘
```

## Файловая структура

```
app/
├── main.py                    # Точка входа
├── bot/
│   ├── handlers/
│   │   ├── workflow.py        # Основной обработчик
│   │   ├── fetch.py
│   │   ├── add_channel.py
│   │   ├── analyze.py
│   │   └── export.py
│   └── middlewares/
│       └── error_handler.py
├── services/
│   ├── workflow_pipeline.py   # Основной пайплайн
│   ├── telegram_parser/       # Telethon интеграция
│   ├── llm/                   # OpenAI интеграция
│   ├── similarity_engine/     # Поиск похожих
│   ├── xlsx_generator.py      # Генерация отчётов
│   └── helpers.py             # Вспомогательные функции
├── db/
│   ├── models.py              # SQLAlchemy модели
│   ├── repo.py                # Репозиторий
│   └── database.py            # Подключение к БД
└── core/
    ├── config.py              # Конфигурация
    └── logging.py             # Логирование
```

## Технологический стек

- **Telegram Bot API**: aiogram 3.x
- **Telegram Client API**: Telethon
- **LLM**: OpenAI GPT API
- **Database**: PostgreSQL + SQLAlchemy
- **Excel**: openpyxl
- **Language**: Python 3.10+

---

*Схема актуальна на 12 декабря 2025*
