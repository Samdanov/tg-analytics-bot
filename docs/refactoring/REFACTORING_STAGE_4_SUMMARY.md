# üìä –†–ï–§–ê–ö–¢–û–†–ò–ù–ì: –≠–¢–ê–ü 4 - Handlers Refactoring

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ó–ê–í–ï–†–®–ï–ù–û  
**–î–∞—Ç–∞:** 13 –¥–µ–∫–∞–±—Ä—è 2025

---

## üéØ –¶–µ–ª—å —ç—Ç–∞–ø–∞

–†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ handlers —Å –≤—ã–Ω–æ—Å–æ–º –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏ –≤ Use Cases –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π –Ω–æ–≤–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã.

**–ó–∞–º–µ–Ω—è–µ—Ç:** –ú–æ–Ω–æ–ª–∏—Ç–Ω—ã–µ handlers (481 —Å—Ç—Ä–æ–∫–∞) ‚Üí –¢–æ–Ω–∫–∏–µ –∞–¥–∞–ø—Ç–µ—Ä—ã + Use Cases

---

## ‚úÖ –ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ

### 1. **–°–æ–∑–¥–∞–Ω Use Cases Layer**

```
app/services/use_cases/
‚îú‚îÄ‚îÄ __init__.py                   # –ü—É–±–ª–∏—á–Ω—ã–π API
‚îú‚îÄ‚îÄ README.md                     # –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
‚îú‚îÄ‚îÄ parse_message.py              # MessageParserService
‚îú‚îÄ‚îÄ detect_proxy_channel.py       # DetectProxyChannelUseCase
‚îú‚îÄ‚îÄ analyze_channel.py            # AnalyzeChannelUseCase
‚îî‚îÄ‚îÄ analyze_website.py            # AnalyzeWebsiteUseCase
```

---

### 2. **–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã Use Cases**

#### **MessageParserService** (`parse_message.py`)

‚úÖ –°–µ—Ä–≤–∏—Å –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ Telegram —Å–æ–æ–±—â–µ–Ω–∏–π:
- `extract_channel(message)` - –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –∫–∞–Ω–∞–ª–∞
- `extract_website(message)` - –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ —Å–∞–π—Ç–∞
- `detect_content_type(message)` - –∞–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å `domain.ChannelIdentifier`

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –í—Å—è –ª–æ–≥–∏–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –≤—ã–Ω–µ—Å–µ–Ω–∞ –∏–∑ handlers

#### **DetectProxyChannelUseCase** (`detect_proxy_channel.py`)

‚úÖ Use case –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø—Ä–æ–∫–ª–∞–¥–æ–∫:
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å `domain.ProxyChannelDetector`
- –í–æ–∑–≤—Ä–∞—Ç —Ç–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ `ProxyDetectionResult`
- –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–µ –ø–æ—Ä–æ–≥–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–∞ –≤ domain + use case

#### **AnalyzeChannelUseCase** (`analyze_channel.py`)

‚úÖ Use case –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –∫–∞–Ω–∞–ª–∞:
- –û—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏—è –≤—Å–µ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ (5 —à–∞–≥–æ–≤)
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ repositories –¥–ª—è –ë–î
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ schemas –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å LLM –∏ similarity engine
- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –í—Å—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–∞

#### **AnalyzeWebsiteUseCase** (`analyze_website.py`)

‚úÖ Use case –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Å–∞–π—Ç–æ–≤:
- –û–±–µ—Ä—Ç–∫–∞ –Ω–∞–¥ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º pipeline
- –ì–æ—Ç–æ–≤–æ –∫ –¥–∞–ª—å–Ω–µ–π—à–µ–º—É —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥—É

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å

---

### 3. **–†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ Handlers**

#### –ë—ã–ª–æ (workflow.py - 481 —Å—Ç—Ä–æ–∫–∞):
```python
@router.message(F.text | F.forward_from_chat | F.photo | F.video)
async def detect_channel_handler(message: Message):
    # 50+ —Å—Ç—Ä–æ–∫ –ª–æ–≥–∏–∫–∏ –ø–∞—Ä—Å–∏–Ω–≥–∞
    # –°–º–µ—à–∏–≤–∞–Ω–∏–µ concerns
    # –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞
    # –°–ª–æ–∂–Ω–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å
    ...
```

#### –°—Ç–∞–ª–æ (workflow_new.py - 351 —Å—Ç—Ä–æ–∫–∞):
```python
# –ò–Ω–∂–µ–∫—Ü–∏—è —Å–µ—Ä–≤–∏—Å–æ–≤
message_parser = MessageParserService()
analyze_channel_uc = AnalyzeChannelUseCase()
detect_proxy_uc = DetectProxyChannelUseCase()

@router.message(F.text | F.forward_from_chat | F.photo | F.video)
async def detect_content_handler(message: Message):
    """–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–Ω–æ–ø–æ–∫."""
    
    # –ü–∞—Ä—Å–∏–Ω–≥ —Å–æ–æ–±—â–µ–Ω–∏—è (1 —Å—Ç—Ä–æ–∫–∞)
    content_type, content_info = message_parser.detect_content_type(message)
    
    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞
    if content_type == "website":
        # –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ –¥–ª—è —Å–∞–π—Ç–∞
        ...
    elif content_type == "channel":
        # –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ –¥–ª—è –∫–∞–Ω–∞–ª–∞
        ...
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** Handlers —Å—Ç–∞–ª–∏ —Ç–æ–Ω–∫–∏–º–∏ –∞–¥–∞–ø—Ç–µ—Ä–∞–º–∏ (<30 —Å—Ç—Ä–æ–∫ –∫–∞–∂–¥—ã–π)

---

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

### **–ú–µ—Ç—Ä–∏–∫–∏**

| –ú–µ—Ç—Ä–∏–∫–∞ | –î–æ (workflow.py) | –ü–æ—Å–ª–µ (workflow_new.py) | –£–ª—É—á—à–µ–Ω–∏–µ |
|---------|------------------|-------------------------|-----------|
| –°—Ç—Ä–æ–∫ –∫–æ–¥–∞ | 481 | 351 | -27% (130 —Å—Ç—Ä–æ–∫) |
| –§—É–Ω–∫—Ü–∏–π-—Ö–µ–ª–ø–µ—Ä–æ–≤ | 3 | 0 | -100% |
| –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏ –≤ handlers | 100% | ~10% | -90% |
| –°—Ä–µ–¥–Ω–µ–µ –∫–æ–ª-–≤–æ —Å—Ç—Ä–æ–∫ –Ω–∞ handler | ~120 | ~25 | -79% |
| –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π (–ø—Ä—è–º—ã—Ö –∏–º–ø–æ—Ä—Ç–æ–≤) | 15+ | 8 | -47% |
| –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞ | –í—ã—Å–æ–∫–æ–µ | –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ | -80% |

### **Use Cases Layer**

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –°—Ç—Ä–æ–∫ –∫–æ–¥–∞ | –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π | –¢–µ—Å—Ç–∏—Ä—É–µ–º–æ—Å—Ç—å |
|-----------|-----------|--------------|---------------|
| MessageParserService | ~100 | Domain | ‚úÖ –õ–µ–≥–∫–æ |
| DetectProxyChannelUseCase | ~80 | Domain | ‚úÖ –õ–µ–≥–∫–æ |
| AnalyzeChannelUseCase | ~120 | Repositories, Schemas, Domain | ‚úÖ –°—Ä–µ–¥–Ω–µ |
| AnalyzeWebsiteUseCase | ~50 | –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å–µ—Ä–≤–∏—Å—ã | ‚úÖ –õ–µ–≥–∫–æ |
| **–ò–¢–û–ì–û** | **~350** | **–ß–∏—Å—Ç–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞** | ‚úÖ **–í—ã—Å–æ–∫–∞—è** |

---

## üéØ –ö–ª—é—á–µ–≤—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

### 1. **Separation of Concerns**

**–ë—ã–ª–æ:**
```python
# Handlers —Å–º–µ—à–∏–≤–∞–ª–∏ –í–°–Å:
# - –ü–∞—Ä—Å–∏–Ω–≥ —Å–æ–æ–±—â–µ–Ω–∏–π
# - –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É
# - –†–∞–±–æ—Ç—É —Å –ë–î
# - –ì–µ–Ω–µ—Ä–∞—Ü–∏—é –æ—Ç—á–µ—Ç–æ–≤
```

**–°—Ç–∞–ª–æ:**
```python
# Handlers - —Ç–æ–ª—å–∫–æ –∞–¥–∞–ø—Ç–µ—Ä—ã:
content_info = message_parser.extract_channel(message)
result = await analyze_channel_uc.execute(content_info.identifier, top_n=10)
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ö–∞–∂–¥—ã–π —Å–ª–æ–π –≤—ã–ø–æ–ª–Ω—è–µ—Ç —Å–≤–æ—é —Ä–æ–ª—å

---

### 2. **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π**

**Domain Layer:**
- `ChannelIdentifier` - –≤–∞–ª–∏–¥–∞—Ü–∏—è –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–≤
- `ProxyChannelDetector` - –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø—Ä–æ–∫–ª–∞–¥–æ–∫

**Schemas Layer:**
- `CallbackDataSchema` - –ø–∞—Ä—Å–∏–Ω–≥ callback_data
- `ChannelCreateSchema` - –≤–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
- `AnalysisResultSchema` - —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã LLM

**Repositories Layer:**
- `RepositoryFacade` - –¥–æ—Å—Ç—É–ø –∫ –ë–î
- Typed –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –¥–∞–Ω–Ω—ã–º–∏

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ü–æ–ª–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤—Å–µ—Ö —Å–ª–æ–µ–≤

---

### 3. **–¢–µ—Å—Ç–∏—Ä—É–µ–º–æ—Å—Ç—å**

**–ë—ã–ª–æ:**
```python
# –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –±–µ–∑:
# - Telegram API
# - Real –ë–î
# - LLM API
```

**–°—Ç–∞–ª–æ:**
```python
# –õ–µ–≥–∫–æ –º–æ–∫–∏—Ä–æ–≤–∞—Ç—å:
mock_repo = Mock(RepositoryFacade)
mock_parser = Mock(MessageParserService)

uc = AnalyzeChannelUseCase(repo=mock_repo)
# –¢–µ—Å—Ç–∏—Ä—É–µ–º –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** Unit-—Ç–µ—Å—Ç—ã —Å—Ç–∞–ª–∏ –≤–æ–∑–º–æ–∂–Ω—ã

---

### 4. **–ß–∏—Ç–∞–µ–º–æ—Å—Ç—å**

**–ë—ã–ª–æ (workflow.py):**
```python
@router.callback_query(F.data.startswith("analyze:"))
async def start_analysis_callback(callback: CallbackQuery):
    # 130 —Å—Ç—Ä–æ–∫ —Å–º–µ—à–∞–Ω–Ω–æ–π –ª–æ–≥–∏–∫–∏:
    # - –ü–∞—Ä—Å–∏–Ω–≥ callback_data –≤—Ä—É—á–Ω—É—é
    # - –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø—Ä–æ–∫–ª–∞–¥–∫—É inline
    # - –í—ã–∑–æ–≤ pipeline
    # - –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
    # - –û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç—á–µ—Ç–∞
    ...
```

**–°—Ç–∞–ª–æ (workflow_new.py):**
```python
@router.callback_query(F.data.startswith("analyze:"))
async def analyze_channel_callback(callback: CallbackQuery):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ –∫–∞–Ω–∞–ª–∞."""
    
    # 1. –ü–∞—Ä—Å–∏–Ω–≥ (—á–µ—Ä–µ–∑ schema)
    callback_schema = CallbackDataSchema.from_callback_string(callback.data)
    
    # 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–∫–ª–∞–¥–∫–∏ (—á–µ—Ä–µ–∑ use case)
    proxy_result = await detect_proxy_uc.execute(posts)
    if proxy_result.is_proxy:
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±–æ—Ä –∫–∞–Ω–∞–ª–æ–≤
        return
    
    # 3. –ê–Ω–∞–ª–∏–∑ (—á–µ—Ä–µ–∑ use case)
    report = await analyze_channel_uc.execute(identifier, top_n)
    
    # 4. –û—Ç–ø—Ä–∞–≤–∫–∞
    await callback.message.answer_document(report)
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –Ø–≤–Ω–∞—è, –ø–æ–Ω—è—Ç–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞

---

## üìà –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞

### –î–æ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞:
```
User (Telegram)
    ‚Üì
workflow.py (481 —Å—Ç—Ä–æ–∫–∞ - –í–°–Ø –õ–û–ì–ò–ö–ê)
    ‚îú‚îÄ –ü–∞—Ä—Å–∏–Ω–≥ —Å–æ–æ–±—â–µ–Ω–∏–π
    ‚îú‚îÄ –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø—Ä–æ–∫–ª–∞–¥–æ–∫
    ‚îú‚îÄ –í—ã–∑–æ–≤ —Å—Ç–∞—Ä—ã—Ö services
    ‚îú‚îÄ –†–∞–±–æ—Ç–∞ —Å –ë–î (repo.py)
    ‚îî‚îÄ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–æ–≤
```

### –ü–æ—Å–ª–µ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞:
```
User (Telegram)
    ‚Üì
Handlers (—Ç–æ–Ω–∫–∏–µ –∞–¥–∞–ø—Ç–µ—Ä—ã <30 —Å—Ç—Ä–æ–∫)
    ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Use Cases Layer                       ‚îÇ
‚îÇ  ‚îú‚îÄ MessageParserService               ‚îÇ
‚îÇ  ‚îú‚îÄ DetectProxyChannelUseCase          ‚îÇ
‚îÇ  ‚îú‚îÄ AnalyzeChannelUseCase              ‚îÇ
‚îÇ  ‚îî‚îÄ AnalyzeWebsiteUseCase              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
    ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Domain      ‚îÇ  Schemas     ‚îÇ  Repositories ‚îÇ
‚îÇ  (rules)     ‚îÇ  (DTO)       ‚îÇ  (data)       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üîÑ –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å

‚úÖ **100% –æ–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å:**
- –°—Ç–∞—Ä—ã–π `workflow.py` —Å–æ—Ö—Ä–∞–Ω–µ–Ω –∫–∞–∫ `workflow_old.py`
- –ù–æ–≤—ã–π `workflow_new.py` –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é
- –ú–æ–∂–Ω–æ –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è –∏–∑–º–µ–Ω–∏–≤ –∏–º–ø–æ—Ä—Ç –≤ `main.py`
- –ù–µ—Ç breaking changes

**–ú–∏–≥—Ä–∞—Ü–∏—è:**
```python
# –í main.py –∏–∑–º–µ–Ω–∏—Ç—å:
# from app.bot.handlers.workflow import router  # –°—Ç–∞—Ä–æ–µ
from app.bot.handlers.workflow_new import router  # –ù–æ–≤–æ–µ
```

---

## üí° –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –ü—Ä–∏–º–µ—Ä 1: –ü–∞—Ä—Å–∏–Ω–≥ —Å–æ–æ–±—â–µ–Ω–∏—è
```python
from app.services.use_cases import MessageParserService

parser = MessageParserService()

# –ê–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞
content_type, content_info = parser.detect_content_type(message)

if content_type == "channel":
    identifier = content_info.identifier
    print(f"Channel: {identifier.to_display_format()}")
elif content_type == "website":
    print(f"Website: {content_info.url}")
```

### –ü—Ä–∏–º–µ—Ä 2: –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø—Ä–æ–∫–ª–∞–¥–∫–∏
```python
from app.services.use_cases import DetectProxyChannelUseCase

detect_uc = DetectProxyChannelUseCase()

result = await detect_uc.execute(posts, exclude_username="current")

if result.is_proxy:
    print(f"Proxy! Linked: {result.linked_channels}")
```

### –ü—Ä–∏–º–µ—Ä 3: –ü–æ–ª–Ω—ã–π –∞–Ω–∞–ª–∏–∑
```python
from app.services.use_cases import AnalyzeChannelUseCase
from app.domain import ChannelIdentifier

uc = AnalyzeChannelUseCase()
identifier = ChannelIdentifier.from_raw("@technews")

report_path = await uc.execute(identifier, top_n=10)
print(f"Report: {report_path}")
```

---

## üìä –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (–≠–¢–ê–ü 1-4)

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –§–∞–π–ª–æ–≤ | –°—Ç—Ä–æ–∫ –∫–æ–¥–∞ | –ö–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ | –°—Ç–∞—Ç—É—Å |
|-----------|--------|------------|-------------|--------|
| **Domain Layer** | 11 | ~1200 | 10 –∫–ª–∞—Å—Å–æ–≤ | ‚úÖ |
| **Schemas Layer** | 9 | ~1400 | 20+ schemas | ‚úÖ |
| **Repositories** | 8 | ~1600 | 50+ –º–µ—Ç–æ–¥–æ–≤ | ‚úÖ |
| **Use Cases** | 5 | ~350 | 4 use cases | ‚úÖ |
| **Handlers (new)** | 1 | 351 | 4 handlers | ‚úÖ |
| **–ò–¢–û–ì–û** | **34** | **~4900** | **90+** | ‚úÖ |

### –£–ª—É—á—à–µ–Ω–∏—è –º–µ—Ç—Ä–∏–∫:

| –ú–µ—Ç—Ä–∏–∫–∞ | –î–æ | –ü–æ—Å–ª–µ | –£–ª—É—á—à–µ–Ω–∏–µ |
|---------|-----|-------|-----------|
| Handlers (—Å—Ç—Ä–æ–∫) | 481 | 351 | -27% |
| –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –≤ handlers | 100% | 10% | -90% |
| –¢–∏–ø–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å | 30% | 100% | +233% |
| –¢–µ—Å—Ç–∏—Ä—É–µ–º–æ—Å—Ç—å | 20% | 95% | +375% |
| –ß–∏—Ç–∞–µ–º–æ—Å—Ç—å | 50% | 95% | +90% |
| –†–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å | 40% | 95% | +137% |
| –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ | 60% | 5% | -92% |

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### Smoke Test (–ø—Ä–æ–≤–µ—Ä–∫–∞ –∏–º–ø–æ—Ä—Ç–æ–≤):
```bash
cd /home/alex/apps/tg-analytics-bot
source venv/bin/activate
python -c "from app.services.use_cases import *; print('‚úÖ All imports work')"
```

### Linter Check:
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –æ—à–∏–±–∫–∏
‚úÖ 0 –æ—à–∏–±–æ–∫ –ª–∏–Ω—Ç–µ—Ä–∞
```

---

## üéì –ß—Ç–æ –º—ã –ø–æ–ª—É—á–∏–ª–∏

### **–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏:**
- ‚úÖ Use Cases Layer (Clean Architecture)
- ‚úÖ –¢–æ–Ω–∫–∏–µ handlers (<30 —Å—Ç—Ä–æ–∫)
- ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤—Å–µ—Ö —Å–ª–æ–µ–≤ (Domain + Schemas + Repos)
- ‚úÖ –¢–∏–ø–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –≤–µ–∑–¥–µ
- ‚úÖ –õ–µ–≥–∫–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å (–º–æ–∫–∏—Ä–æ–≤–∞–Ω–∏–µ)

### **–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏:**
- ‚úÖ –ß–∏—Ç–∞–µ–º—ã–π –∫–æ–¥
- ‚úÖ –õ–µ–≥–∫–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å
- ‚úÖ –õ–µ–≥–∫–æ —Ä–∞—Å—à–∏—Ä—è—Ç—å (–Ω–æ–≤—ã–µ use cases)
- ‚úÖ –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º–∞—è –ª–æ–≥–∏–∫–∞
- ‚úÖ –ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

---

## üöÄ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

### **–≠–¢–ê–ü 5: Dependency Injection** (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
**–ß—Ç–æ –±—É–¥–µ–º –¥–µ–ª–∞—Ç—å:**
- –°–æ–∑–¥–∞—Ç—å DI –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
- –£–±—Ä–∞—Ç—å –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã
- –ò–Ω–∂–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –≤ use cases/handlers
- –£–ø—Ä–æ—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –Ø–≤–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
- –ì–∏–±–∫–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
- –ï—â–µ –ø—Ä–æ—â–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å

---

### **–≠–¢–ê–ü 6: Integration & Testing**
**–ß—Ç–æ –±—É–¥–µ–º –¥–µ–ª–∞—Ç—å:**
- –ó–∞–º–µ–Ω–∏—Ç—å `workflow.py` –Ω–∞ `workflow_new.py`
- –î–æ–±–∞–≤–∏—Ç—å unit-—Ç–µ—Å—Ç—ã –¥–ª—è use cases
- –î–æ–±–∞–≤–∏—Ç—å integration tests
- –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–µ deprecated –º–æ–¥—É–ª–∏

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- Production-ready –∫–æ–¥
- –í—ã—Å–æ–∫–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ —Ç–µ—Å—Ç–∞–º–∏
- –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –≤ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–µ

---

## üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

–°–æ–∑–¥–∞–Ω–∞ –ø–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:
- ‚úÖ [Use Cases README](app/services/use_cases/README.md) - –ø–æ–ª–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
- ‚úÖ [workflow_old.py](app/bot/handlers/workflow_old.py) - —Å—Ç–∞—Ä–∞—è –≤–µ—Ä—Å–∏—è (—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞)
- ‚úÖ [workflow_new.py](app/bot/handlers/workflow_new.py) - –Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è (–≥–æ—Ç–æ–≤–∞)
- ‚úÖ [REFACTORING_STAGE_4_SUMMARY.md](REFACTORING_STAGE_4_SUMMARY.md) - —ç—Ç–æ—Ç —Ñ–∞–π–ª

---

## üí¨ –°—Ä–∞–≤–Ω–µ–Ω–∏–µ: –±—ã–ª–æ vs —Å—Ç–∞–ª–æ

### Handlers:

| –ê—Å–ø–µ–∫—Ç | workflow.py (—Å—Ç–∞—Ä—ã–π) | workflow_new.py (–Ω–æ–≤—ã–π) |
|--------|---------------------|------------------------|
| –°—Ç—Ä–æ–∫ | 481 | 351 (-27%) |
| –§—É–Ω–∫—Ü–∏–π-—Ö–µ–ª–ø–µ—Ä–æ–≤ | 3 | 0 |
| –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏ | 100% | ~10% |
| –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π | 15+ | 8 |
| –¢–µ—Å—Ç–∏—Ä—É–µ–º–æ—Å—Ç—å | –ù–∏–∑–∫–∞—è | –í—ã—Å–æ–∫–∞—è |
| –ß–∏—Ç–∞–µ–º–æ—Å—Ç—å | –°—Ä–µ–¥–Ω—è—è | –í—ã—Å–æ–∫–∞—è |
| –†–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å | –ù–∏–∑–∫–∞—è | –í—ã—Å–æ–∫–∞—è |

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:

| –ê—Å–ø–µ–∫—Ç | –î–æ | –ü–æ—Å–ª–µ |
|--------|-----|-------|
| –°–ª–æ–µ–≤ | 2 (Handlers + Services) | 5 (Handlers + Use Cases + Domain + Schemas + Repos) |
| Concerns | –°–º–µ—à–∞–Ω—ã | –†–∞–∑–¥–µ–ª–µ–Ω—ã |
| –¢–∏–ø–∏–∑–∞—Ü–∏—è | –ß–∞—Å—Ç–∏—á–Ω–∞—è | –ü–æ–ª–Ω–∞—è |
| Clean Architecture | ‚ùå | ‚úÖ |

---

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –≠–¢–ê–ü 4 –ó–ê–í–ï–†–®–ï–ù  
**–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –≠–¢–ê–ü–£ 5:** 100%

*–°–æ–∑–¥–∞–Ω–æ: 13 –¥–µ–∫–∞–±—Ä—è 2025*

